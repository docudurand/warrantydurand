<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>DSG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/docudurand/warrantydurand/main/DSG.png">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f9fafb; margin:0; }
    .banniere { width: 100vw; max-width: 100%; margin: 0; padding: 0; display: block; object-fit: cover; min-height: 60px; max-height: 180px; background: #fff; box-shadow: 0 2px 18px #0001;}
    .top-tools { width: 100vw; max-width: 100%; display: flex; justify-content: flex-end; align-items: center; gap: 18px; margin-top: 30px; margin-bottom: 30px; padding-right: 2.5vw; }
    .top-tools button { background:#1780b0; color:#fff; border-radius:20px 0 0 20px; padding:8px 20px 8px 16px; border:none; box-shadow:0 2px 6px #0001; font-size:1.03em; cursor:pointer; display:block; transition: background 0.13s, color 0.13s;}
    #login { max-width:380px; margin:90px auto; background:#fff; border-radius:10px; box-shadow:0 2px 12px #0001; padding:38px 28px; text-align:center;}
    #admin-content { display:none; width: 99vw; max-width: 1920px; margin:34px auto 0 auto; background:#fff; border-radius:24px; box-shadow:0 3px 20px #0001; padding:54px 48px 48px 48px; box-sizing: border-box; overflow-x: auto; min-width: 320px;}
    h2 { color:#006e90; font-size:2.28em; font-weight:bold; text-align:center; margin-bottom:20px; letter-spacing: 0.01em;}
    .filters-row { display: flex; gap: 18px; align-items: center; justify-content: flex-end; margin-bottom: 16px; flex-wrap: wrap;}
    .filters-row label { font-size: 1.06em; color: #195e7c; margin-right: 6px; }
    .filters-row select { padding: 5px 9px; border-radius: 7px; border: 1px solid #b4c8d8; font-size: 1.05em; margin-right: 14px; }
    .filters-row .search-container { margin-right: auto; display: flex; align-items: center; }
    .filters-row input[type="text"] { font-size:1.08em; padding: 8px 13px; border-radius: 7px; border: 1px solid #b4c8d8; width: 240px; box-shadow:0 2px 6px #0001;}
    .tabs { display:flex; gap:11px; justify-content:center; margin-bottom:34px; flex-wrap:wrap;}
    .tab { padding: 12px 34px; border-radius: 10px 10px 0 0; cursor: pointer; background: #f0f6f9; font-weight: 600; color: #146083; font-size: 1.14em; border: 1.5px solid #cbe7f6; border-bottom: 0; min-width: 182px; text-align: center; transition: background 0.18s, color 0.18s; box-sizing: border-box; word-break: break-word; white-space: normal;}
    .tab.active { background: #006e90; color: #fff; z-index: 1; }
    #status-counters { display:flex; gap:35px; justify-content:center; margin-bottom:22px; flex-wrap: wrap;}
    .counter-card { background: #fff; border-radius: 13px; box-shadow: 0 2px 12px #0001; padding: 32px 40px 26px 40px; display: flex; flex-direction: column; align-items: center; min-width: 220px; margin-bottom: 7px;}
    .counter-card .counter-label { font-size: 1.13em; color:#234156; margin-bottom:13px; }
    .counter-card .counter-label.orange { color: #f8a900; }
    .counter-card .counter-label.green { color: #168b3e; }
    .counter-card .counter-label.red { color: #bb1810; }
    .counter-card .counter-value { font-size: 2.45em; font-weight: bold; margin-bottom:2px;}
    .counter-card .counter-value.orange { color: #f8a900; }
    .counter-card .counter-value.green { color: #168b3e; }
    .counter-card .counter-value.red { color: #bb1810; }
    table { width:100%; border-collapse:collapse; margin-bottom:16px; table-layout:fixed;}
    th, td { border:1px solid #e6edf1; padding:12px 7px; text-align:center; font-size:1.09em;}
    th { background:#006e90; color:#fff; font-size:1.12em; font-weight:600;}
    tr:nth-child(even) td { background:#f4fafd;}
    td.action, th.action { min-width: 215px; max-width: 330px; }
    .statut-select { padding:7px 13px; border-radius:5px; border:1px solid #b4c8d8; }
    .bouton, .voir-btn, .maj-btn { background:#006e90; color:#fff; border:none; padding:7px 20px; border-radius:6px; cursor:pointer; font-size:1em; box-shadow:0 1px 4px #0002; transition:background 0.15s;}
    .bouton:hover, .voir-btn:hover, .maj-btn:hover { background:#1780b0;}
    .pj-img { max-width:70px; max-height:54px; border-radius:3px; box-shadow:0 1px 3px #0002; }
    #dossier-list p {margin-top:15px;}
    .mini-form-row td { background: #e8f3fa; border-top: 0 ; border-bottom: 2px solid #b3c9d9 ; padding-top: 19px ; padding-bottom: 19px ;}
    .mini-form { display: flex; align-items: flex-end; gap:15px; justify-content: center; width: 100%; }
    .mini-form textarea { min-width:160px; min-height:32px; font-size:0.97em; padding:4px 8px; border-radius:6px; border:1px solid #c3d2e0;}
    .mini-form input[type="file"] { margin-top:0; }
    .mini-form input[name="numero_avoir"] { min-width: 120px; padding: 6px 8px; font-size: 0.98em; border-radius:6px; border:1px solid #c3d2e0;}
    .mini-form select { font-size:0.97em;}
    .mini-form .bouton { margin-left:7px;}
    .mini-form .admin-msg { color:#259a54; font-size:0.98em;}
    .maj-btn { background: #1780b0; padding: 7px 12px;}
    .statut-chip { display:inline-flex; align-items:center; gap:6px; font-weight:600; font-size:1em;}
    .statut-dot { display:inline-block; width:15px; height:15px; border-radius:50%; margin-right:2px; }
    .statut-dot.enregistre { background:#f8a900; border: 2px solid #f7ce65; }
    .statut-dot.accepte { background:#16c11c; border: 2px solid #a6ebba; }
    .statut-dot.refuse { background:#bb1810; border: 2px solid #f49e9e; }
    .statut-dot.info { background:#1978d2; border: 2px solid #93c7fa; }
    #dossier-list td[id^="pj-"] a {
      word-break: break-all;
      white-space: normal;
      display: inline-block;
      max-width: 210px;
    }
    .mini-form label { font-size: 0.98em; color: #195e7c; margin-bottom: 0; margin-right:7px; }
    .pj-documents { font-size: 0.93em; line-height: 1.2; word-break: break-all; white-space: normal; }
    .pj-documents a { font-size: 0.93em; word-break: break-all;}
    .mini-form-encadre {
      overflow-x: auto;
      border: 2px solid #111;
      background: #e8f3fa;
      border-radius: 4px;
      padding: 12px 16px 10px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 7px;
      margin-bottom: 0;
      margin-right: 18px;
      min-width: 0;
      max-width: 900px;
      width: 100%;
      box-sizing: border-box;
    }
    .mini-form-flex {
      display: flex;
      flex-direction: row;
      gap: 28px;
      align-items: flex-end;
      justify-content: flex-start;
      width: 100%;
      flex-wrap: wrap;
      box-sizing: border-box;
      min-width: 0;
      max-width: 100%;
    }
    .mini-form-encadre .mini-form-flex > * {
      margin-bottom: 0;
      white-space: nowrap;
    }
    .mini-form-encadre textarea {
      min-width: 145px;
      max-width: 320px;
    }
    @media (max-width: 900px) {
      .mini-form-encadre .mini-form-flex {
        flex-wrap: wrap;
        gap: 10px;
      }
      .mini-form-encadre textarea {
        min-width: 100px;
        max-width: 100%;
      }
    }
    .mini-form-avert {
      width: 100%;
      text-align: center;
      font-size: 0.79em;
      font-weight: 500;
      color: #234156;
      margin-bottom: 4px;
      margin-top: 0;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      flex-wrap: wrap;
      background: none;
    }
    .mini-form-avert .emoji {
      font-size: 1.10em;
      color: #f2a000;
    }
    .file-list {
      margin: 4px 0 0 0;
      padding: 0;
      list-style: none;
    }
    .file-list li {
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.97em;
    }
    .file-remove {
      background: #c62828;
      color: #fff;
      border: none;
      border-radius: 3px;
      padding: 2px 9px;
      cursor: pointer;
      font-size: 0.93em;
    }
    .file-remove:hover {
      background: #a11610;
    }
    @media (max-width:1050px) {
      #admin-content { padding: 10px 2vw 10px 2vw;}
      .counter-card { padding:18px 7vw;}
      h2 { font-size:1.28em;}
      .top-tools { padding-right: 0.5vw;}
      .filters-row { flex-direction:column; align-items:stretch; gap:10px;}
      .filters-row .search-container { margin: 0 0 8px 0; width: 100%; }
    }
    @media (max-width:700px) {
      #admin-content {max-width: 99vw; padding: 2vw 1vw;}
      .tabs { gap:4px;}
      .tab { min-width: 86px; font-size:0.94em;}
      #status-counters {flex-direction:column;align-items:center;gap:13px;}
      .counter-card { min-width: 160px; padding:13px 1vw;}
      .mini-form textarea { min-width: 60vw;}
      .banniere { min-height: 32px; max-height: 80px;}
      .top-tools { margin-top: 14px; margin-bottom: 18px; flex-direction: column; align-items: flex-end;}
      .filters-row { flex-direction:column; align-items:stretch; gap:10px;}
      .filters-row .search-container { margin: 0 0 8px 0; width: 100%; }
    }
    .mini-form-flex label[style*="flex-direction:column"] b {
      font-size: 1em;
      font-weight: 500;
      color: #195e7c;
      margin-bottom: 2px;
    }
    .mini-form-encadre { margin-bottom: 0; }
    .mini-form-flex > div { min-width: 140px; }
    @media (max-width: 650px) {
      .mini-form-flex { flex-direction: column ; gap: 15px; }
    }
    .mini-form-flex textarea {
      min-width: 110px;
      max-width: 230px;
      min-height: 28px;
      font-size: 0.96em;
      padding: 4px 6px;
    }
    .mini-form-flex select,
    .mini-form-flex input[type="file"] {
      font-size: 0.96em;
      padding: 5px 9px;
    }
    .mini-form-upload-block {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 20px;
      min-width: 185px;
      max-width: 240px;
      width: 100%;
      box-sizing: border-box;
    }
    .mini-form-upload-block label {
      margin-bottom: 2px;
    }
    .mini-form-upload-block input[type="file"] {
      margin-bottom: 2px;
      min-height: 32px;
      box-sizing: border-box;
    }
    .mini-form-upload-block .file-list {
      width: 100%;
      max-width: 240px;
      overflow-x: auto;
      word-break: break-all;
      overflow-wrap: break-word;
      white-space: normal;
    }
    .mini-form-upload-block .file-list li {
      max-width: 220px;
      overflow-x: auto;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: block;
    }
    .mini-form-upload-block .file-list li span {
      display: inline-block;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <img src="https://raw.githubusercontent.com/docudurand/warrantydurand/main/banniere.png" alt="Bannière Garantie Durand Services" class="banniere">
  <div class="top-tools" id="top-tools" style="display:none;">
    <button id="btn-export-excel" title="Exporter les données au format Excel">⬇️ Export données</button>
  </div>
  <div id="login">
    <h2>Connexion admin</h2>
    <input type="password" id="admin-pass" placeholder="Mot de passe" style="width:85%;padding:13px 9px;font-size:1.08em;margin-bottom:18px;border-radius:5px;border:1px solid #b4c8d8;"><br>
    <button class="bouton" onclick="adminLogin()">Connexion</button>
    <div id="login-msg" style="margin-top:12px;color:#d23b33;"></div>
  </div>
  <div id="admin-content">
    <h2>Gestion des dossiers - Garantie Durand Services</h2>
    <div class="tabs" id="tabs"></div>
    <div id="status-counters"></div>
    <div class="filters-row" id="filters-row" style="display:none;">
      <div class="search-container">
        <input type="text" id="search-client" placeholder="🔎 Recherche ..." autocomplete="off">
      </div>
      <label>Mois : <select id="mois-filter"><option value="">Tous</option></select></label>
      <label>Année : <select id="annee-filter"><option value="">Toutes</option></select></label>
      <label id="statut-filter-label">Statut :
        <select id="statut-filter">
          <option value="">Tous</option>
          <option value="enregistré">Enregistré</option>
          <option value="accepté">Accepté</option>
          <option value="refusé">Refusé</option>
          <option value="en attente d'info">En attente d'info</option>
        </select>
      </label>
    </div>
    <div id="dossier-list"></div>
  </div>
  <div id="completer-modal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#0007;">
    <div id="completer-modal-content" style="background:#fff;margin:40px auto;max-width:750px;padding:34px 28px;border-radius:16px;position:relative;">
      <button onclick="fermerCompleterModal()" style="position:absolute;top:13px;right:13px;font-size:1.4em;">✖️</button>
      <form id="form-completer-dossier">
      </form>
    </div>
  </div>
  <script>
    let isSuperAdmin = false;
    let allDossiers = [];
    let currentMagasin = null;
    let rechercheClient = "";
    let filtres = { mois: "", annee: "", statut: "" };
    const MAGASINS = [
      "Annemasse","Bourgoin-Jallieu","Chasse-sur-Rhone","Chassieu","Gleize","La Motte-Servolex",
      "Les Echets","Pavi","Rives","Saint-Egreve","Saint-Jean-Bonnefonds","Saint-martin-d'heres","Seynod"
    ];

    document.getElementById("admin-content").style.display = "none";
    document.getElementById("top-tools").style.display = "none";

    function adminLogin() {
      let pass = document.getElementById("admin-pass").value.trim();
      document.getElementById("login-msg").textContent = "Connexion...";
      fetch("/api/admin/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pass })
      })
        .then(r => r.json())
        .then(j => {
          if (j.success) {
            document.getElementById("login").style.display = "none";
            document.getElementById("admin-content").style.display = "";
            document.getElementById("top-tools").style.display = "";
            isSuperAdmin = j.isSuper;
            chargerDossiers();
          } else {
            document.getElementById("login-msg").textContent = "Mot de passe incorrect";
          }
        })
        .catch(() => {
          document.getElementById("login-msg").textContent = "Erreur réseau";
        });
    }

    async function chargerDossiers() {
      document.getElementById("dossier-list").innerHTML = "Chargement...";
      let r = await fetch("/api/admin/dossiers");
      let data = await r.json();
      allDossiers = Array.isArray(data) ? data : [];
      afficherOnglets();
      afficherDossiers(currentMagasin || MAGASINS[0]);
    }

    function afficherOnglets() {
      let html = MAGASINS.map(m =>
        `<button class="bouton" style="margin-right:8px;${currentMagasin === m ? 'background:#1780b0;color:#fff;' : ''}" onclick="afficherDossiers('${m}',true)">${m}</button>`
      ).join("");
      document.getElementById("tabs").innerHTML = html;
    }

    function afficherCompteurs(dossiers) {
      let total = dossiers.length;
      let enreg = dossiers.filter(d => d.statut === "enregistré").length;
      let accepte = dossiers.filter(d => d.statut === "accepté").length;
      let refuse = dossiers.filter(d => d.statut === "refusé").length;
      let attente = dossiers.filter(d => d.statut === "en attente d'info").length;
      document.getElementById("status-counters").innerHTML = `
        <span style="margin-right:15px;">Total : <b>${total}</b></span>
        <span style="color:#f8a900;margin-right:15px;">Enregistré : <b>${enreg}</b></span>
        <span style="color:#16c11c;margin-right:15px;">Accepté : <b>${accepte}</b></span>
        <span style="color:#bb1810;margin-right:15px;">Refusé : <b>${refuse}</b></span>
        <span style="color:#1978d2;">En attente d'info : <b>${attente}</b></span>
      `;
    }

    function afficherFiltres(dossiers) {
      let moisSet = new Set(), anneeSet = new Set();
      dossiers.forEach(d => {
        let date = new Date(d.date);
        if (!isNaN(date)) {
          moisSet.add(("0" + (date.getMonth() + 1)).slice(-2));
          anneeSet.add(date.getFullYear().toString());
        }
      });
      const moisFr = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
      const moisLib = ["Jan", "Fév", "Mar", "Avr", "Mai", "Juin", "Juil", "Août", "Sep", "Oct", "Nov", "Déc"];
      let moisSel = document.getElementById("mois-filter");
      moisSel.innerHTML = `<option value="">Tous</option>`;
      moisFr.forEach((m, i) => { if (moisSet.has(m)) moisSel.innerHTML += `<option value="${m}">${moisLib[i]}</option>`; });
      let anneeSel = document.getElementById("annee-filter");
      anneeSel.innerHTML = `<option value="">Toutes</option>`;
      Array.from(anneeSet).sort().forEach(a => anneeSel.innerHTML += `<option value="${a}">${a}</option>`);
    }

    document.getElementById("search-client").oninput = function () {
      rechercheClient = this.value;
      afficherDossiers(currentMagasin);
    };
    document.getElementById("mois-filter").onchange = function () {
      filtres.mois = this.value;
      afficherDossiers(currentMagasin);
    };
    document.getElementById("annee-filter").onchange = function () {
      filtres.annee = this.value;
      afficherDossiers(currentMagasin);
    };
    document.getElementById("statut-filter").onchange = function () {
      filtres.statut = this.value;
      afficherDossiers(currentMagasin);
    };

    function statutChip(statut) {
      let s = (statut || "").toLowerCase();
      if (s === "enregistré") return `<span class="statut-chip"><span class="statut-dot enregistre"></span>Enregistré</span>`;
      if (s === "accepté") return `<span class="statut-chip"><span class="statut-dot accepte"></span>Accepté</span>`;
      if (s === "refusé") return `<span class="statut-chip"><span class="statut-dot refuse"></span>Refusé</span>`;
      if (s === "en attente d'info") return `<span class="statut-chip"><span class="statut-dot info"></span>En attente d'info</span>`;
      return statut || "";
    }
    function afficherDossiers(magasin, forceFiltres=false) {
      currentMagasin = magasin;
      afficherOnglets();
      let dossiers = allDossiers.filter(d => d.magasin === magasin);

      if (rechercheClient && rechercheClient.trim().length > 0) {
        const rc = rechercheClient.trim().toLowerCase();
        dossiers = dossiers.filter(d => {
          const numero = (d.numero_dossier || "").toString().padStart(4, "0");
          return (
            (d.nom || "").toLowerCase().includes(rc) ||
            (d.produit_concerne || "").toLowerCase().includes(rc) ||
            (d.reference_piece || "").toLowerCase().includes(rc) ||
            (d.marque_produit || "").toLowerCase().includes(rc) ||
            numero.includes(rc)
          );
        });
      }

      afficherCompteurs(dossiers);
      afficherFiltres(dossiers);

      if (filtres.mois) {
        dossiers = dossiers.filter(d => {
          let date = new Date(d.date);
          return !isNaN(date) && ("0" + (date.getMonth() + 1)).slice(-2) === filtres.mois;
        });
      }
      if (filtres.annee) {
        dossiers = dossiers.filter(d => {
          let date = new Date(d.date);
          return !isNaN(date) && date.getFullYear().toString() === filtres.annee;
        });
      }
      if (filtres.statut) {
        dossiers = dossiers.filter(d => d.statut === filtres.statut);
      }

      let html = `<table>
        <tr>
          <th style="width: 90px;">Numéro de dossier</th>
          <th>Date</th>
          <th>Client</th>
          <th>Produit</th>
          <th>Référence de la pièce</th>
          <th>Marque du produit</th>
          <th>Statut</th>
          <th>Réponse</th>
          <th>Documents ajoutés</th>
          <th class="action">Mettre à jour</th>
          <th class="action">Voir</th>
          ${isSuperAdmin ? '<th class="action">Supprimer</th>' : ''}
        </tr>`;
      dossiers.forEach(d => {
        let id = d.id;
        let fichiersDocs = [].concat(
          d.files || [],
          d.documentsAjoutes || [],
          d.reponseFiles || []
        );
        fichiersDocs = fichiersDocs.filter((f, i, arr) =>
          f && f.url && arr.findIndex(x => x.url === f.url) === i
        );
        html += `<tr>
          <td>${d.numero_dossier || ''}</td>
          <td>${new Date(d.date).toLocaleDateString("fr-FR")}</td>
          <td>${d.nom || ''}</td>
          <td>${d.produit_concerne || ''}</td>
          <td>${d.reference_piece || ''}</td>
          <td>${d.marque_produit || ''}</td>
          <td id="statut-${id}">${statutChip(d.statut)}</td>
          <td id="reponse-${id}">${d.reponse ? d.reponse.replace(/\n/g, "<br>") : ''}</td>
          <td id="pj-${id}">
          <div class="pj-documents">
            ${
              fichiersDocs.length
                ? fichiersDocs.map(f => {
                    let ext = f.original.split('.').pop().toLowerCase();
                    if (["jpg", "jpeg", "png", "gif", "webp", "bmp"].includes(ext)) {
                      return `<a href="/download/${f.url}" target="_blank"><img src="/download/${f.url}" class="pj-img"></a>`;
                    } else {
                      return `<a href="/download/${f.url}" target="_blank">${f.original}</a>`;
                    }
                  }).join("<br>")
                : ""
            }
          </div>
          </td>
          <td class="action">
            <button class="maj-btn" data-id="${id}">Mettre à jour</button>
            <button class="completer-btn" data-id="${id}">Compléter Dossier</button>
          </td>
          <td class="action"><button class="voir-btn" onclick="voirDossier('${d.id}')">Voir</button></td>
          ${isSuperAdmin ? `<td class="action"><button class="bouton" style="background:#bb1810" onclick="supprimerDossier('${id}')">Supprimer</button></td>` : ''}
        </tr>`;
      });
      html += `</table>`;
      document.getElementById('dossier-list').innerHTML = html;
      document.querySelectorAll('.completer-btn').forEach(btn => {
        btn.onclick = function () {
          const id = btn.getAttribute('data-id');
          const dossier = allDossiers.find(d => d.id === id);
          ouvrirCompleterModal(dossier);
        }
      });
    }

    function ouvrirCompleterModal(dossier) {
      let html = `
        <label>Nom du client :</label>
        <input type="text" name="nom" required value="${dossier.nom || ''}"/>
        <label>Email :</label>
        <input type="email" name="email" required value="${dossier.email || ''}"/>
        <label>Magasin :</label>
        <select name="magasin" required>
          ${MAGASINS.map(m => `<option value="${m}"${dossier.magasin === m ? ' selected' : ''}>${m}</option>`).join("")}
        </select>
        <label>Marque du produit :</label>
        <input type="text" name="marque_produit" required value="${dossier.marque_produit || ''}"/>
        <label>Produit concerné :</label>
        <input type="text" name="produit_concerne" required value="${dossier.produit_concerne || ''}"/>
        <label>Référence de la pièce :</label>
        <input type="text" name="reference_piece" required value="${dossier.reference_piece || ''}"/>
        <label>Quantité posée :</label>
        <input type="number" name="quantite_posee" required value="${dossier.quantite_posee || ''}"/>
        <label>Immatriculation :</label>
        <input type="text" name="immatriculation" required value="${dossier.immatriculation || ''}"/>
        <label>Marque :</label>
        <input type="text" name="marque_vehicule" value="${dossier.marque_vehicule || ''}"/>
        <label>Modèle :</label>
        <input type="text" name="modele_vehicule" value="${dossier.modele_vehicule || ''}"/>
        <label>Numéro de série :</label>
        <input type="text" name="num_serie" value="${dossier.num_serie || ''}"/>
        <label>1ère immatriculation :</label>
        <input type="date" name="premiere_immat" value="${dossier.premiere_immat || ''}"/>
        <label>Date de pose :</label>
        <input type="date" name="date_pose" required value="${dossier.date_pose || ''}"/>
        <label>Date du constat :</label>
        <input type="date" name="date_constat" required value="${dossier.date_constat || ''}"/>
        <label>Kilométrage à la pose :</label>
        <input type="number" name="km_pose" required value="${dossier.km_pose || ''}"/>
        <label>Kilométrage au constat :</label>
        <input type="number" name="km_constat" required value="${dossier.km_constat || ''}"/>
        <label>N° BL 1ère Vente :</label>
        <input type="text" name="bl_pose" required value="${dossier.bl_pose || ''}"/>
        <label>N° BL 2ème Vente :</label>
        <input type="text" name="bl_constat" value="${dossier.bl_constat || ''}"/>
        <label>Problème rencontré :</label>
        <textarea name="probleme_rencontre" rows="5" required>${dossier.probleme_rencontre || ''}</textarea>
        <div style="display:flex;gap:18px;margin-top:22px;">
          <button type="submit" class="bouton" style="width:120px;">Valider</button>
          <button type="button" class="bouton" onclick="fermerCompleterModal()" style="background:#ccc;color:#234;">Annuler</button>
        </div>
        <div id="completer-msg" style="margin-top:15px;color:#148c36;font-weight:bold;"></div>
      `;
      document.getElementById("form-completer-dossier").innerHTML = html;
      document.getElementById("completer-modal").style.display = "block";
      document.getElementById("form-completer-dossier").onsubmit = function (ev) {
        ev.preventDefault();
        validerCompleterDossier(dossier.id, new FormData(this));
      }
    }
    function fermerCompleterModal() {
      document.getElementById("completer-modal").style.display = "none";
    }

    async function validerCompleterDossier(id, formData) {
      document.getElementById("completer-msg").textContent = "Mise à jour...";
      const data = {};
      formData.forEach((v, k) => data[k] = v);
      let resp = await fetch(`/api/admin/completer/${id}`, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      let json = await resp.json();
      if (json.success) {
        document.getElementById("completer-msg").textContent = "✔ Dossier modifié";
        setTimeout(() => {
          fermerCompleterModal();
          chargerDossiers();
        }, 900);
      } else {
        document.getElementById("completer-msg").textContent = json.message || "Erreur";
      }
    }
    function voirDossier(id) {
      const d = allDossiers.find(x => x.id === id);
      if (!d) return alert("Dossier introuvable !");
      let logoUrl = "https://raw.githubusercontent.com/docudurand/warrantydurand/main/DSG.png";
      let dateCreation = d.date ? new Date(d.date).toLocaleDateString("fr-FR") : "";
      let clientNom = (d.nom || "Client").replace(/[^a-zA-Z0-9]/g, "_").toUpperCase();
      let dateStr = "";
      if (d.date) {
        let dt = new Date(d.date);
        if (!isNaN(dt)) {
          dateStr = dt.toISOString().slice(0, 10);
        }
      }
      let nomFichier = `${clientNom}${dateStr ? "_" + dateStr : ""}`;
      let detailHtml = `
        <html><head>
        <meta charset="UTF-8">
        <title>${nomFichier}</title>
        <style>
          body { font-family: 'Segoe UI', Arial, sans-serif; background:#f9fafb; margin:0; }
          .fiche-header { display:flex; align-items:center; gap:18px; margin-bottom:18px; }
          .fiche-header img { height:62px; border-radius:11px; box-shadow:0 2px 12px #0001; background:#fff;}
          .fiche-header .magasin-title { font-size:1.22em; font-weight:600; color:#17537a; }
          .fiche-date { margin-left:auto; font-size:1.08em; color:#444; font-weight:bold;}
          .fiche-table { max-width:700px; margin:30px auto; background:#fff; border-radius:10px; border:1px solid #e5e7eb; padding:18px 24px 14px 24px; }
          .fiche-table table { width:100%; border-collapse:collapse; }
          .fiche-table th, .fiche-table td { text-align:left; padding:8px 10px; border:none; }
          .fiche-table th { color:#194e72; font-size:1.06em; text-align:left; width:220px; vertical-align:top;}
          .fiche-table tr { border-bottom:1px solid #f0f0f0;}
          .fiche-title { font-weight:bold; color:#006e90; padding-top:24px; font-size:1.08em;}
          .fiche-actions { text-align:right; margin-bottom:14px;}
          .print-btn { background:#006e90; color:#fff; border:none; padding:9px 22px; border-radius:7px; font-size:1.07em; font-weight:600; cursor:pointer; margin-left:7px;}
          .print-btn:hover { background:#1780b0; }
          @media print {
            .print-btn { display:none !important; }
            body { background: #fff; }
            .fiche-table { box-shadow: none; border:1px solid #888;}
            .fiche-header { padding-top:10px; }
            .hide-print { display:none !important; }
            .fiche-date { display:block !important; position:absolute; top:24px; right:40px; font-size:1.09em;}
          }
          .statut-chip { display:inline-flex; align-items:center; gap:6px; font-weight:600; font-size:1em;}
          .statut-dot { display:inline-block; width:15px; height:15px; border-radius:50%; margin-right:2px; }
          .statut-dot.enregistre { background:#f8a900; border: 2px solid #f7ce65; }
          .statut-dot.accepte { background:#16c11c; border: 2px solid #a6ebba; }
          .statut-dot.refuse { background:#bb1810; border: 2px solid #f49e9e; }
          .statut-dot.info { background:#1978d2; border: 2px solid #93c7fa; }
        </style>
        </head><body>
        <div class="fiche-header">
          <img src="${logoUrl}" alt="Logo DSG">
          <span class="magasin-title">${d.magasin || ""}</span>
          <span class="fiche-date">${dateCreation}</span>
        </div>
        <div class="fiche-table">
          <table>
            <tr><th>Nom du client</th><td>${d.nom || ""}</td></tr>
            <tr><th>Email</th><td>${d.email || ""}</td></tr>
            <tr><th>Statut</th><td>${statutChip(d.statut)}</td></tr>
            <tr><th>Marque du produit</th><td>${d.marque_produit || ""}</td></tr>
            <tr><th>Produit concerné</th><td>${d.produit_concerne || ""}</td></tr>
            <tr><th>Référence de la pièce</th><td>${d.reference_piece || ""}</td></tr>
            <tr><th>Quantité posée</th><td>${d.quantite_posee || ""}</td></tr>
            <tr><th>Immatriculation</th><td>${d.immatriculation || ""}</td></tr>
            <tr><th>Marque véhicule</th><td>${d.marque_vehicule || ""}</td></tr>
            <tr><th>Modèle véhicule</th><td>${d.modele_vehicule || ""}</td></tr>
            <tr><th>Numéro de série</th><td>${d.num_serie || ""}</td></tr>
            <tr><th>1ère immatriculation</th><td>${d.premiere_immat || ""}</td></tr>
            <tr><th>Date de pose</th><td>${d.date_pose || ""}</td></tr>
            <tr><th>Date du constat</th><td>${d.date_constat || ""}</td></tr>
            <tr><th>Kilométrage à la pose</th><td>${d.km_pose || ""}</td></tr>
            <tr><th>Kilométrage au constat</th><td>${d.km_constat || ""}</td></tr>
            <tr><th>N° BL 1ère Vente</th><td>${d.bl_pose || ""}</td></tr>
            <tr><th>N° BL 2ème Vente</th><td>${d.bl_constat || ""}</td></tr>
            <tr><th>Problème rencontré</th><td>${(d.probleme_rencontre||"").replace(/\n/g,"<br>")}</td></tr>
            <tr><th>Réponse</th><td>${(d.reponse||"").replace(/\n/g,"<br>")}</td></tr>
            <tr><th>Documents</th><td>
            ${
              [].concat(d.files||[],d.documentsAjoutes||[],d.reponseFiles||[])
                .filter(f=>f && f.url)
                .map(f=>`<a href="/download/${f.url}" target="_blank">${f.original}</a>`)
                .join("<br>")
            }
            </td></tr>
          </table>
        </div>
        <div class="fiche-actions hide-print">
          <button class="print-btn" onclick="window.print()">Imprimer</button>
          <button class="print-btn" onclick="window.close()">Fermer</button>
        </div>
        </body></html>
      `;
      let win = window.open("", "_blank", "width=850,height=950");
      win.document.write(detailHtml);
      win.document.close();
    }

    async function supprimerDossier(id) {
      if (!confirm("Supprimer ce dossier ? Opération irréversible !")) return;
      let resp = await fetch(`/api/admin/dossier/${id}`, {
        method: "DELETE",
        headers: { "x-superadmin": "1" }
      });
      let json = await resp.json();
      if (json.success) {
        chargerDossiers();
      } else {
        alert(json.message || "Erreur suppression");
      }
    }

    document.getElementById("btn-export-excel").onclick = function () {
      window.open("/api/admin/export-excel", "_blank");
    };
    function formatDateFRshort(val) {
      if (!val) return "";
      let d = typeof val === "string" ? new Date(val) : val;
      if (typeof val === "string" && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
        let [y, m, d2] = val.split("-");
        return `${d2}/${m}/${y.slice(2)}`;
      }
      if (!isNaN(d)) {
        let day = ("0"+d.getDate()).slice(-2);
        let month = ("0"+(d.getMonth()+1)).slice(-2);
        let year = d.getFullYear().toString().slice(-2);
        return `${day}/${month}/${year}`;
      }
      return val;
    }
  </script>
</body>
</html>

