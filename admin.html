<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Dossiers garantie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f9fafb; margin:0; }
    #login { max-width:380px; margin:90px auto; background:#fff; border-radius:10px; box-shadow:0 2px 12px #0001; padding:38px 28px; text-align:center;}
    #admin-content {
      display:none;
      width: 98vw;
      max-width: 1620px;
      margin:34px auto 0 auto;
      background:#fff;
      border-radius:24px;
      box-shadow:0 3px 20px #0001;
      padding:44px 32px 38px 32px;
      box-sizing: border-box;
      overflow-x: auto;
      min-width: 320px;
    }
    h2 { color:#006e90; font-size:2.28em; font-weight:bold; text-align:center; margin-bottom:20px; letter-spacing: 0.01em;}
    .top-bar {display:flex; justify-content:center; gap:25px; margin-bottom:25px;}
    .tabs { display:flex; gap:11px; justify-content:center; margin-bottom:34px; flex-wrap:wrap;}
    .tab {
      padding: 12px 34px; border-radius: 10px 10px 0 0; cursor: pointer;
      background: #f0f6f9; font-weight: 600; color: #146083; font-size: 1.14em;
      border: 1.5px solid #cbe7f6; border-bottom: 0; min-width: 182px; text-align: center;
      transition: background 0.18s, color 0.18s; box-sizing: border-box; word-break: break-word; white-space: normal;
    }
    .tab.active { background: #006e90; color: #fff; z-index: 1; }
    #status-counters { display:flex; gap:35px; justify-content:center; margin-bottom:22px; flex-wrap: wrap;}
    .counter-card { background: #fff; border-radius: 13px; box-shadow: 0 2px 12px #0001; padding: 32px 40px 26px 40px; display: flex; flex-direction: column; align-items: center; min-width: 220px; margin-bottom: 7px;}
    .counter-card .counter-label { font-size: 1.13em; color:#234156; margin-bottom:13px; }
    .counter-card .counter-label.orange { color: #f8a900; }
    .counter-card .counter-label.green { color: #168b3e; }
    .counter-card .counter-label.red { color: #bb1810; }
    .counter-card .counter-value { font-size: 2.45em; font-weight: bold; margin-bottom:2px;}
    .counter-card .counter-value.orange { color: #f8a900; }
    .counter-card .counter-value.green { color: #168b3e; }
    .counter-card .counter-value.red { color: #bb1810; }
    table { width:100%; border-collapse:collapse; margin-bottom:16px; }
    th, td { border:1px solid #e6edf1; padding:12px 7px; text-align:center; font-size:1.09em;}
    th { background:#006e90; color:#fff; font-size:1.12em; font-weight:600;}
    tr:nth-child(even) td { background:#f4fafd;}
    .statut-select { padding:7px 13px; border-radius:5px; border:1px solid #b4c8d8; }
    .bouton, .voir-btn { background:#006e90; color:#fff; border:none; padding:7px 20px; border-radius:6px; cursor:pointer; font-size:1em; box-shadow:0 1px 4px #0002; transition:background 0.15s;}
    .bouton:hover, .voir-btn:hover { background:#1780b0;}
    .pj-img { max-width:70px; max-height:54px; border-radius:3px; box-shadow:0 1px 3px #0002; }
    #dossier-list p {margin-top:15px;}
    .reponse-form { display:flex; gap:12px; align-items:center; margin:0; flex-wrap:wrap;}
    .reponse-form textarea { min-width:260px; min-height:38px; font-size:1em; padding:8px 10px; border-radius:6px; border:1px solid #c3d2e0;}
    .reponse-form input[type="file"] { margin-left:8px;}
    .reponse-form button { margin-left:5px;}
    .admin-msg { font-size:1.05em; color:#259a54; margin-left:11px;}
    @media (max-width:1700px) {
      #admin-content { max-width: 98vw; }
      .tab { min-width: 130px; padding: 10px 20px; font-size: 1em; }
    }
    @media (max-width:1050px) {
      .tab { min-width: 100px; padding: 8px 8px; font-size: 0.99em; }
      #admin-content { padding: 10px 2vw 10px 2vw;}
      .counter-card { padding:18px 7vw;}
      h2 { font-size: 1.28em;}
    }
    @media (max-width:700px) {
      #admin-content {max-width: 99vw; padding: 2vw 1vw;}
      .tabs { gap:4px;}
      .tab { min-width: 86px; font-size:0.94em;}
      #status-counters {flex-direction:column;align-items:center;gap:13px;}
      .counter-card { min-width: 160px; padding:13px 1vw;}
      .reponse-form textarea { min-width:80vw; }
    }
  </style>
</head>
<body>
  <div id="login">
    <h2>Connexion admin</h2>
    <input type="password" id="admin-pass" placeholder="Mot de passe" style="width:85%;padding:13px 9px;font-size:1.08em;margin-bottom:18px;border-radius:5px;border:1px solid #b4c8d8;"><br>
    <button class="bouton" onclick="adminLogin()">Connexion</button>
    <div id="login-msg" style="margin-top:12px;color:#d23b33;"></div>
  </div>

  <div id="admin-content">
    <h2>Gestion des dossiers - Garantie Durand Services</h2>
    <div class="top-bar">
      <button id="btn-export" class="bouton" style="background:#1780b0;">Sauvegarder (exporter)</button>
      <form id="form-import" style="display:inline;" enctype="multipart/form-data">
        <label for="import-backup" style="cursor:pointer;" class="bouton" title="Restaurer √† partir d'une sauvegarde">
          Importer sauvegarde
          <input type="file" id="import-backup" name="backup" accept="application/json" style="display:none;">
        </label>
      </form>
      <span id="import-msg" style="font-size:1.03em; color:#1780b0; margin-left:8px;"></span>
    </div>
    <div class="tabs" id="tabs"></div>
    <div id="status-counters"></div>
    <div id="dossier-list"></div>
  </div>

  <script>
    const BASE_URL = "";
    const MAGASINS = [
      "Annemasse","Bourgoin-Jallieu","Chasse-sur-Rhone","Chassieu","Gleize","La Motte-Servolex","Les Echets","Rives","Saint-Egreve","Saint-Jean-Bonnefonds","Saint-martin-d'heres","Seynod"
    ];
    let allDossiers = [];
    let currentMagasin = MAGASINS[0];

    function adminLogin() {
      let pw = document.getElementById('admin-pass').value;
      fetch('/api/admin/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({password: pw})
      })
      .then(resp=>resp.json())
      .then(json=>{
        if(json.success){
          document.getElementById('login').style.display = "none";
          document.getElementById('admin-content').style.display = "block";
          chargerDossiers();
        } else {
          document.getElementById('login-msg').textContent = json.message || "Erreur";
        }
      });
    }

    // Bouton export
    document.addEventListener('DOMContentLoaded', ()=>{
      if(document.getElementById("btn-export")){
        document.getElementById("btn-export").onclick = function(){
          window.open("/api/admin/export", "_blank");
        };
      }
      // Import
      if(document.getElementById("import-backup")){
        document.getElementById("import-backup").onchange = function(){
          let file = this.files[0];
          if (!file) return;
          let fd = new FormData();
          fd.append("backup", file);
          document.getElementById("import-msg").textContent = "Importation...";
          fetch("/api/admin/import", {
            method:"POST",
            body:fd
          }).then(r=>r.json()).then(json=>{
            if(json.success){
              document.getElementById("import-msg").textContent = "Importation r√©ussie ‚úî";
              chargerDossiers();
            } else {
              document.getElementById("import-msg").textContent = "Erreur : " + (json.message||"Format invalide");
            }
            setTimeout(()=>{document.getElementById("import-msg").textContent="";}, 2800);
          });
        };
      }
    });

    function chargerDossiers() {
      fetch('/api/admin/dossiers').then(r=>r.json()).then(data=>{
        allDossiers = data;
        afficherOnglets();
        afficherDossiers(currentMagasin);
      });
    }

    function afficherOnglets() {
      let t = '';
      MAGASINS.forEach((m, i) => {
        t += `<div class="tab${m === currentMagasin ? " active" : ""}" data-magasin="${encodeURIComponent(m)}" id="onglet-${i}">${m}</div>`;
      });
      document.getElementById('tabs').innerHTML = t;
      MAGASINS.forEach((m, i) => {
        document.getElementById('onglet-' + i).onclick = function() {
          afficherDossiers(decodeURIComponent(this.getAttribute('data-magasin')));
        }
      });
    }

    function afficherCompteurs(dossiers) {
      const stats = [
        { label: "En attente de traitement <span title='Enregistr√©'>‚è≥</span>", val: "enregistr√©", color:"orange" },
        { label: "Accept√©s <span>üëç</span>", val: "accept√©", color:"green" },
        { label: "En attente d'info", val: "en attente d'info", color:"green" },
        { label: "Refus√©s <span>üëé</span>", val: "refus√©", color:"red" }
      ];
      let html = "";
      stats.forEach(stat => {
        const n = dossiers.filter(d => d.statut === stat.val).length;
        html += `
          <div class="counter-card">
            <span class="counter-label ${stat.color}">${stat.label}</span>
            <span class="counter-value ${stat.color}">${n}</span>
          </div>
        `;
      });
      document.getElementById("status-counters").innerHTML = html;
    }

    function afficherDossiers(magasin) {
      currentMagasin = magasin;
      afficherOnglets();
      let dossiers = allDossiers.filter(d=>d.magasin===magasin);
      afficherCompteurs(dossiers);
      if(!dossiers.length){
        document.getElementById('dossier-list').innerHTML = `<p style='color:#d23b33;font-size:1.18em;text-align:center;'>Aucun dossier pour ce magasin</p>`;
        return;
      }
      let html = `<table>
        <tr>
          <th>Date</th>
          <th>Client</th>
          <th>Produit</th>
          <th>Immatriculation</th>
          <th>Statut</th>
          <th>Pi√®ces jointes</th>
          <th>R√©ponse</th>
          <th>Voir</th>
        </tr>`;
      dossiers.forEach(d=>{
        html += `<tr>
          <td>${new Date(d.date).toLocaleDateString("fr-FR")}</td>
          <td>${d.nom||''}</td>
          <td>${d.produit_concerne||''}</td>
          <td>${d.immatriculation||''}</td>
          <td>
            <select class="statut-select" onchange="changerStatut('${d.id}', this.value)">
              <option value="enregistr√©"${d.statut==="enregistr√©"?" selected":""}>Enregistr√©</option>
              <option value="accept√©"${d.statut==="accept√©"?" selected":""}>Accept√©</option>
              <option value="refus√©"${d.statut==="refus√©"?" selected":""}>Refus√©</option>
              <option value="en attente d'info"${d.statut==="en attente d'info"?" selected":""}>En attente d'info</option>
            </select>
          </td>
          <td>`;
        if (d.files && d.files.length)
          d.files.forEach(f=>{
            let ext = f.original.split('.').pop().toLowerCase();
            if(["jpg","jpeg","png","gif","webp","bmp"].includes(ext)){
              html += `<a href="/download/${f.url}" target="_blank"><img src="/uploads/${f.url}" class="pj-img"></a>`;
            } else {
              html += `<a href="/download/${f.url}" target="_blank">${f.original}</a>`;
            }
          });
        html += `</td>
          <td>
            ${d.reponse ? `<div style="margin-bottom:5px;">${d.reponse}</div>` : ""}
            ${d.reponseFiles && d.reponseFiles.length ? d.reponseFiles.map(f=>{
              let ext = f.original.split('.').pop().toLowerCase();
              if(["jpg","jpeg","png","gif","webp","bmp"].includes(ext)){
                return `<a href="/download/${f.url}" target="_blank"><img src="/uploads/${f.url}" class="pj-img"></a>`;
              } else {
                return `<a href="/download/${f.url}" target="_blank">${f.original}</a>`;
              }
            }).join("<br>") : ""}
            <form class="reponse-form" data-id="${d.id}" enctype="multipart/form-data" style="margin-top:10px;">
              <textarea name="reponse" placeholder="R√©ponse (optionnel)"></textarea>
              <input type="file" name="reponseFiles" multiple>
              <button type="submit" class="bouton">R√©pondre</button>
              <span class="admin-msg"></span>
            </form>
          </td>
          <td><button class="voir-btn" onclick="voirDossier('${d.id}')">Voir</button></td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById('dossier-list').innerHTML = html;

      // Ajout de l'envoi asynchrone pour chaque mini-formulaire r√©ponse
      document.querySelectorAll('.reponse-form').forEach(form => {
        form.onsubmit = async function(e) {
          e.preventDefault();
          let id = this.getAttribute('data-id');
          let fd = new FormData();
          let reponse = this.querySelector('textarea').value;
          fd.append("reponse", reponse);
          let files = this.querySelector('input[type="file"]').files;
          for (let f of files) fd.append("reponseFiles", f);
          // Envoi
          this.querySelector('.admin-msg').textContent = "Envoi...";
          let resp = await fetch(`/api/admin/dossier/${id}`, { method:"POST", body:fd });
          let json = await resp.json();
          if (json.success) {
            this.querySelector('.admin-msg').textContent = "R√©ponse envoy√©e ‚úî";
            chargerDossiers();
          } else {
            this.querySelector('.admin-msg').textContent = "Erreur";
          }
        };
      });
    }

    function changerStatut(id, statut) {
      fetch(`/api/admin/dossier/${id}`, {
        method: 'POST',
        body: JSON.stringify({statut}),
        headers: {'Content-Type':'application/json'}
      })
      .then(r=>r.json())
      .then(json=>{
        if(json.success) chargerDossiers();
        else alert(json.message || "Erreur lors du changement de statut");
      });
    }

    function voirDossier(id) {
      let d = allDossiers.find(x=>x.id===id);
      if (!d) return alert("Dossier introuvable !");
      let detailHtml = `
        <html><head>
        <meta charset="UTF-8">
        <title>D√©tail dossier</title>
        <style>
          body { font-family: 'Segoe UI', Arial, sans-serif; background:#f9fafb; margin:0; }
          .fiche-table { max-width:700px; margin:30px auto; background:#fff; border-radius:10px; border:1px solid #e5e7eb; padding:18px 24px 14px 24px; }
          .fiche-table table { width:100%; border-collapse:collapse; }
          .fiche-table th, .fiche-table td { text-align:left; padding:8px 10px; border:none; }
          .fiche-table th { color:#194e72; font-size:1.06em; text-align:left; width:220px; vertical-align:top;}
          .fiche-table tr { border-bottom:1px solid #f0f0f0;}
          .fiche-title { font-weight:bold; color:#006e90; padding-top:24px; font-size:1.08em;}
          .pj-img { max-width:180px; max-height:120px; display:block; margin-bottom:6px; border-radius:5px; box-shadow:0 2px 6px #0002; }
        </style>
        </head><body>
        <div class="fiche-table">
          <table>
            <tr><th>Nom du client</th><td>${d.nom||""}</td></tr>
            <tr><th>Email</th><td>${d.email||""}</td></tr>
            <tr><th>Magasin</th><td>${d.magasin||""}</td></tr>
            <tr><td colspan="2" class="fiche-title">Produit</td></tr>
            <tr><th>Marque du produit</th><td>${d.marque_produit||""}</td></tr>
            <tr><th>Produit concern√©</th><td>${d.produit_concerne||""}</td></tr>
            <tr><th>R√©f√©rence de la pi√®ce</th><td>${d.reference_piece||""}</td></tr>
            <tr><th>Quantit√© pos√©e</th><td>${d.quantite_posee||""}</td></tr>
            <tr><td colspan="2" class="fiche-title">V√©hicule</td></tr>
            <tr><th>Immatriculation</th><td>${d.immatriculation||""}</td></tr>
            <tr><th>Marque</th><td>${d.marque_vehicule||""}</td></tr>
            <tr><th>Mod√®le</th><td>${d.modele_vehicule||""}</td></tr>
            <tr><th>Num√©ro de s√©rie</th><td>${d.num_serie||""}</td></tr>
            <tr><th>1√®re immatriculation</th><td>${d.premiere_immat||""}</td></tr>
            <tr><td colspan="2" class="fiche-title">Probl√®me</td></tr>
            <tr><th>Date de pose</th><td>${d.date_pose||""}</td></tr>
            <tr><th>Date du constat</th><td>${d.date_constat||""}</td></tr>
            <tr><th>Kilom√©trage √† la pose</th><td>${d.km_pose||""}</td></tr>
            <tr><th>Kilom√©trage au constat</th><td>${d.km_constat||""}</td></tr>
            <tr><th>N¬∞ BL 1√®re Vente</th><td>${d.bl_pose||""}</td></tr>
            <tr><th>N¬∞ BL 2√®me Vente</th><td>${d.bl_constat||""}</td></tr>
            <tr><th>Probl√®me rencontr√©</th><td>${d.probleme_rencontre||""}</td></tr>
            <tr><th>Date de cr√©ation du dossier</th><td>${(new Date(d.date)).toLocaleDateString("fr-FR")}</td></tr>
            <tr><th>Statut</th><td>${d.statut||""}</td></tr>
            <tr><th>Pi√®ces jointes</th><td>
              ${
                (d.files||[]).length === 0
                  ? 'Aucune'
                  : d.files.map(f=>{
                      let ext = f.original.split('.').pop().toLowerCase();
                      if(["jpg","jpeg","png","gif","webp","bmp"].includes(ext)){
                        return `<a href="/download/${f.url}" target="_blank"><img src="/uploads/${f.url}" class="pj-img"></a>`;
                      } else {
                        return `<a href="/download/${f.url}" target="_blank">${f.original}</a>`;
                      }
                    }).join("<br>")
              }
            </td></tr>
            <tr><th>R√©ponse</th><td>
              ${(d.reponse||"")}
              ${(d.reponseFiles||[]).length
                  ? "<br>"+d.reponseFiles.map(f=>{
                    let ext = f.original.split('.').pop().toLowerCase();
                    if(["jpg","jpeg","png","gif","webp","bmp"].includes(ext)){
                      return `<a href="/download/${f.url}" target="_blank"><img src="/uploads/${f.url}" class="pj-img"></a>`;
                    } else {
                      return `<a href="/download/${f.url}" target="_blank">${f.original}</a>`;
                    }
                  }).join("<br>")
                  : ""}
            </td></tr>
          </table>
        </div>
        </body></html>
      `;
      let w = window.open("", "_blank", "width=820,height=900");
      w.document.write(detailHtml);
      w.document.close();
    }
  </script>
</body>
</html>
