<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>DSG - Admin Garantie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    rel="icon"
    type="image/png"
    href="https://raw.githubusercontent.com/docudurand/warrantydurand/main/DSG.png"
  />
<style>
    * { box-sizing: border-box; }
    body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f3f4f7;
  color: #123046;
  font-size: 1.08rem;
}
html {
  font-size: 18px;   /* au lieu des ~16px par d√©faut */
}
    .banner {
      width: 100%;
      background: linear-gradient(135deg, #0f3c5e, #176a9d);
      color: #fff;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 2px 10px #0003;
    }
    .banner img {
      height: 52px;
      width: 52px;
    }
    .banner-title {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }
	
    .banner-sub {
      font-size: 0.9rem;
      opacity: 0.85;
    }

    #login {
      max-width: 420px;
      margin: 70px auto;
      background: #fff;
      padding: 30px 26px 34px;
      border-radius: 14px;
      box-shadow: 0 10px 30px #0002;
    }
    #login h2 {
      margin: 0 0 20px;
      font-size: 1.45rem;
      text-align: center;
      color: #0f3c5e;
    }
    #login label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #234;
    }
    #login input[type="password"] {
      width: 100%;
      padding: 9px 10px;
      border-radius: 8px;
      border: 1px solid #c5ced9;
      font-size: 1rem;
      outline: none;
    }
    #login input[type="password"]:focus {
      border-color: #176a9d;
      box-shadow: 0 0 0 1px #176a9d33;
    }
    #login button {
      margin-top: 18px;
      width: 100%;
      padding: 10px 0;
      border-radius: 8px;
      border: none;
      background: #176a9d;
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
    }
    #login button:hover {
      background: #115176;
    }
    #login-msg {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #b00020;
      min-height: 18px;
      text-align: center;
    }

    #admin-content {
      display: none;
      padding: 18px 14px 40px;
    }
    .top-tools {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
      margin-bottom: 16px;
    }
    .top-left {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .top-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #0f3c5e;
    }
    .top-sub {
      font-size: 0.95rem;
      color: #567;
    }
    .top-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .btn {
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      padding: 7px 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      background: #176a9d;
      color: #fff;
    }
    .btn.secondary {
      background: #fff;
      color: #176a9d;
      border: 1px solid #176a9d66;
    }
    .btn.danger {
      background: #cc1f1f;
      color: #fff;
    }
    .btn:hover {
      filter: brightness(1.05);
    }
    .chip-role {
      padding: 2px 9px;
      background: #0f3c5e;
      border-radius: 999px;
      font-size: 0.8rem;
      color: #fff;
    }

    .year-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    .year-tab {
      padding: 5px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      border: 1px solid #d0d7e4;
      background: #fff;
      color: #234;
    }
    .year-tab.active {
      background: #176a9d;
      color: #fff;
      border-color: #176a9d;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
      margin-bottom: 12px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 160px;
      font-size: 0.85rem;
    }
    .filter-group label {
      font-weight: 600;
      color: #234;
    }
    .filter-group select,
    .filter-group input[type="text"],
    .filter-group input[type="month"] {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #c4cfdd;
      font-size: 0.9rem;
      outline: none;
      background: #fff;
    }
    .filter-group select:focus,
    .filter-group input[type="text"]:focus,
    .filter-group input[type="month"]:focus {
      border-color: #176a9d;
      box-shadow: 0 0 0 1px #176a9d33;
    }
    #search-input {
  min-width: 160px;
  max-width: 260px;
  width: 100%;
}

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 14px 0 18px;
    }
    .stat-card {
      flex: 1 1 180px;
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 2px 10px #0001;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 3px solid transparent;
      font-size: 0.9rem;
    }
    .stat-card span.label {
      font-weight: 600;
      color: #345;
    }
    .stat-card span.value {
      font-weight: 700;
      font-size: 1.2rem;
    }
    .stat-orange { border-top-color: #ff9800; }
    .stat-green { border-top-color: #4caf50; }
    .stat-blue { border-top-color: #2196f3; }
    .stat-purple { border-top-color: #9c27b0; }
    .stat-red { border-top-color: #f44336; }

    .layout-main {
  display: grid;
  grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.2fr);
  gap: 14px;
  align-items: flex-start;
}
    @media (max-width: 1000px) {
      .layout-main {
        grid-template-columns: 1fr;
      }
    }

    .dossier-list {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 12px #0001;
  padding: 10px 10px 4px;
  /* agrandit davantage la hauteur de la liste des dossiers pour afficher plus de lignes */
  max-height: calc(100vh - 80px);
  overflow: auto;
}

   .dossier-row {
  padding: 8px 4px;
  border-bottom: 1px solid #eef1f5;
  cursor: pointer;
  display: grid;
  /* colonne n¬∞ dossier | infos client | magasin/ID | statut */
  grid-template-columns: 90px 1fr auto auto;
  gap: 8px;
  align-items: center;
}
.dossier-num {
  font-weight: 600;
  font-size: 0.85rem;
  color: #123046;
  text-align: center;
  white-space: nowrap;
}
    .dossier-row:last-child {
      border-bottom: none;
    }
    .dossier-row:hover {
      background: #f4f7fb;
    }
    .dossier-row.active {
      background: #e6f3ff;
    }
    .dossier-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.9rem;
    }
    .dossier-title {
      font-weight: 600;
      color: #183751;
    }
    .dossier-sub {
      font-size: 0.8rem;
      color: #667;
    }
    .badge-magasin {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef4ff;
      font-size: 0.75rem;
      color: #234;
    }
    .dossier-id {
      font-size: 0.75rem;
      color: #789;
    }

    .statut-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 999px;
      background: #eef3fb;
      color: #234;
    }
    .statut-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ccc;
    }
    .statut-dot.enregistre { background: #ff9800; }
    .statut-dot.accepte { background: #4caf50; }
    .statut-dot.refuse { background: #f44336; }
    .statut-dot.info { background: #2196f3; }
    .statut-dot.attente-mo { background: #9c27b0; }

    .empty-msg {
      padding: 16px 10px 20px;
      text-align: center;
      font-size: 0.95rem;
      color: #b00020;
      background: #fff8e1;
      border-radius: 10px;
      margin: 8px;
      box-shadow: 0 2px 10px #0001;
    }

    .detail-panel {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
      padding: 12px 14px 14px;
      min-height: 220px;
    }
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      gap: 8px;
    }
    .detail-header-title {
      font-size: 1.05rem;
      font-weight: 700;
      color: #123046;
    }
    .detail-header-sub {
      font-size: 0.85rem;
      color: #678;
    }
    .detail-body {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 16px;
    }
    .detail-field-label {
      font-weight: 600;
      font-size: 0.85rem;
      color: #345;
    }
    .detail-field-value {
      font-size: 0.9rem;
      color: #234;
      word-break: break-word;
    }
    .detail-form {
  margin-top: 2px;
  border-top: 1px solid #e2e6f0;
  padding-top: 2px;
  display: flex;
  flex-direction: column;
  gap: 0;
}
.detail-separator {
  margin-top: 4px !important;
  margin-bottom: 2px !important;
}

.detail-warning-title {
  margin-top: 0 !important;
  margin-bottom: 2px !important;
}
    .detail-form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .detail-form-group {
  display: flex;
  flex-direction: column;
  gap: 2px;
  flex: 1 1 170px;
  font-size: 0.85rem;
  /* supprime toute marge verticale pour coller les √©l√©ments les uns aux autres */
  margin: 0;
}
    .detail-form-group label {
      font-weight: 600;
      color: #345;
    }
    .detail-form-group select,
    .detail-form-group input[type="text"],
    .detail-form-group textarea,
    .detail-form-group input[type="file"] {
      font-size: 0.9rem;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #c4cfdd;
      outline: none;
      background: #fff;
    }
    .detail-form-group textarea {
      resize: vertical;
      min-height: 40px;
    }
    .detail-form-group input:focus,
    .detail-form-group select:focus,
    .detail-form-group textarea:focus {
      border-color: #176a9d;
      box-shadow: 0 0 0 1px #176a9d33;
    }
    .detail-files-list {
      font-size: 0.85rem;
      color: #345;
      display: flex;
      flex-wrap: wrap;
      gap: 4px 8px;
    }
    .file-pill {
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef3ff;
      font-size: 0.8rem;
      color: #234;
    }
    .attente-mo-check {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  margin-top: 4px;
}
.switch {
  position: relative;
  display: inline-block;
  width: 46px;
  height: 24px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.2s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: #fff;
  transition: 0.2s;
  border-radius: 50%;
}

.switch input:checked + .slider {
  background-color: #176a9d;
}

.switch input:checked + .slider:before {
  transform: translateX(22px);
}


    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: #0007;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px 16px;
      max-width: 520px;
      width: 94vw;
      box-shadow: 0 8px 24px #0004;
      font-size: 0.9rem;
    }
    .modal h3 {
      margin: 0 0 8px;
      font-size: 1.05rem;
      color: #0f3c5e;
    }
    .modal-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }
    .modal-row label {
      font-weight: 600;
      font-size: 0.85rem;
    }
    .modal-row select,
    .modal-row textarea,
    .modal-row input[type="file"] {
      font-size: 0.9rem;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #c4cfdd;
      background: #fff;
      outline: none;
    }
    .modal-row textarea {
      resize: vertical;
      min-height: 40px;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }
  
    .file-list {
      margin: 4px 0 0 0;
      padding: 0;
      list-style: none;
    }
    .file-list li {
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
    }
    .file-remove {
      background: #c62828;
      color: #fff;
      border: none;
      border-radius: 3px;
      padding: 0 6px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .file-remove:hover {
      background: #a11610;
    }
    .detail-form-group.reponse-client + .detail-form-group {
      margin-top: 0 !important;
    }
    #edit-modal-backdrop .modal {
      background: #fff;
      border-radius: 12px;
      padding: 20px 22px;
      max-width: 850px;
      width: 95vw;
      box-shadow: 0 8px 24px #0004;
      font-size: 0.95rem;
    }
    #edit-modal-backdrop h3 {
      color: #006e90;
      font-size: 1.35rem;
      margin: 0 0 20px;
    }
    #edit-modal-backdrop .modifier-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px 20px;
    }
    #edit-modal-backdrop .modifier-grid .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    #edit-modal-backdrop .modifier-grid .field.full {
      grid-column: 1 / -1;
    }
    #edit-modal-backdrop .modifier-grid .field label {
      font-weight: 600;
      color: #195e7c;
      margin-bottom: 3px;
      font-size: 0.95rem;
    }
    #edit-modal-backdrop .modifier-grid .field input,
    #edit-modal-backdrop .modifier-grid .field select,
    #edit-modal-backdrop .modifier-grid .field textarea {
      padding: 8px;
      font-size: 0.95rem;
      border: 1px solid #b4c8d8;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    #edit-modal-backdrop .modifier-grid .field textarea {
      resize: vertical;
      min-height: 70px;
    }
    #edit-modal-backdrop .modal-buttons {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      justify-content: center;
    }
	/* === Ajustement des espaces demand√©s dans le formulaire d√©tail === */

/* 1) Coller l'input "Documents ajout√©s au dossier" avec la barre + texte rouge */
#docs-group {
  margin-top: 2px !important;
  margin-bottom: 0 !important;
}
#docs-group .file-list,
#docs-ajoutes-buffer {
  margin: 0 !important;
  padding: 0 !important;
}

/* 2) Coller la zone "R√©ponse au client" avec le titre "Pi√®ces jointes..." */
.detail-form-group.reponse-client {
  margin-bottom: 0 !important;
}
.detail-form-group.reponse-client textarea {
  margin-bottom: 0 !important;
}
#reponse-group {
  margin-top: 2px !important;   /* colle le titre juste sous la zone de texte */
}
#reponse-group .file-list,
#reponse-files-buffer {
  margin: 0 !important;
  padding: 0 !important;
}
.detail-buttons {
  margin-top: 4px !important;
}

</style>
</head>
<body>
  <div class="banner">
    <img src="https://raw.githubusercontent.com/docudurand/warrantydurand/main/DSG.png" alt="DSG">
    <div>
      <div class="banner-title">DURAND SERVICES GARANTIE</div>
      <div class="banner-sub">Administration des dossiers de garantie</div>
    </div>
  </div>

  <div class="modal-backdrop" id="edit-modal-backdrop" style="display:none;">
    <div class="modal">
      <h3>Modifier le dossier</h3>
      <form id="modifier-form">
        <div class="modifier-grid">
          <div class="field">
            <label>Nom du client</label>
            <input type="text" name="nom" required>
          </div>
          <div class="field">
            <label>Email</label>
            <input type="email" name="email" required>
          </div>
          <div class="field">
            <label>Magasin</label>
            <input type="text" name="magasin" list="magasins-list">
          </div>
          <div class="field">
            <label>Marque du produit</label>
            <input type="text" name="marque_produit">
          </div>
          <div class="field">
            <label>Produit concern√©</label>
            <input type="text" name="produit_concerne">
          </div>
          <div class="field">
            <label>R√©f√©rence de la pi√®ce</label>
            <input type="text" name="reference_piece">
          </div>
          <div class="field">
            <label>Quantit√© pos√©e</label>
            <input type="number" name="quantite_posee" min="0">
          </div>
          <div class="field">
            <label>Immatriculation</label>
            <input type="text" name="immatriculation">
          </div>
          <div class="field">
            <label>Marque v√©hicule</label>
            <input type="text" name="marque_vehicule">
          </div>
          <div class="field">
            <label>Mod√®le v√©hicule</label>
            <input type="text" name="modele_vehicule">
          </div>
          <div class="field">
            <label>Num√©ro de s√©rie</label>
            <input type="text" name="num_serie">
          </div>
          <div class="field">
            <label>1√®re immatriculation</label>
            <input type="date" name="premiere_immat">
          </div>
          <div class="field">
            <label>Date de pose</label>
            <input type="date" name="date_pose">
          </div>
          <div class="field">
            <label>Date du constat</label>
            <input type="date" name="date_constat">
          </div>
          <div class="field">
            <label>Kilom√©trage √† la pose</label>
            <input type="number" name="km_pose" min="0">
          </div>
          <div class="field">
            <label>Kilom√©trage au constat</label>
            <input type="number" name="km_constat" min="0">
          </div>
          <div class="field">
            <label>N¬∞ BL 1√®re Vente</label>
            <input type="text" name="bl_pose">
          </div>
          <div class="field">
            <label>N¬∞ BL 2√®me Vente</label>
            <input type="text" name="bl_constat">
          </div>
          <div class="field full">
            <label>Probl√®me rencontr√©</label>
            <textarea name="probleme_rencontre" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn secondary" id="modifier-annuler">Annuler</button>
          <button type="submit" class="btn" id="modifier-valider">Valider</button>
        </div>
      </form>
      <!-- datalist pour autocompl√©ter les magasins -->
      <datalist id="magasins-list"></datalist>
    </div>
  </div>

  <div id="login">
    <h2>Acc√®s administration</h2>
    <label for="admin-password">Mot de passe</label>
    <input type="password" id="admin-password" autocomplete="current-password">
    <button id="login-btn">Se connecter</button>
    <div id="login-msg"></div>
  </div>

  <div id="admin-content">
    <div class="top-tools">
      <div class="top-left">
        <div class="top-title">Suivi des dossiers de garantie</div>
        <div class="top-sub">
          Filtrez, mettez √† jour les dossiers et exportez les donn√©es.
          <span id="role-chip" class="chip-role" style="display:none;"></span>
        </div>
      </div>
      <div class="top-right">
        <button id="btn-export" class="btn" title="Exporter toutes les demandes en Excel">
          üìä Export Excel
        </button>
      </div>
    </div>

    <div class="year-tabs" id="year-tabs"></div>

    <div class="filters">
      <div class="filter-group">
        <label for="month-filter">Mois</label>
        <input type="month" id="month-filter">
      </div>
      <div class="filter-group" id="magasin-filter-group">
  <label for="magasin-filter">Magasin</label>
  <select id="magasin-filter">
          <option value="">Tous</option>
          <option value="Annemasse">Annemasse</option>
          <option value="Bourgoin-Jallieu">Bourgoin-Jallieu</option>
          <option value="Chasse-sur-Rhone">Chasse-sur-Rhone</option>
          <option value="Chassieu">Chassieu</option>
          <option value="Gleize">Gleize</option>
          <option value="La Motte-Servolex">La Motte-Servolex</option>
          <option value="Les Echets">Les Echets</option>
          <option value="Pavi">Pavi</option>
          <option value="Rives">Rives</option>
          <option value="Saint-Egreve">Saint-Egreve</option>
          <option value="Saint-Jean-Bonnefonds">Saint-Jean-Bonnefonds</option>
          <option value="Saint-martin-d'heres">Saint-martin-d'heres</option>
          <option value="Seynod">Seynod</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="statut-filter">Statut</label>
        <select id="statut-filter">
          <option value="">Tous</option>
          <option value="enregistr√©">Enregistr√©</option>
          <option value="accept√©">Accept√©</option>
          <option value="refus√©">Refus√©</option>
          <option value="Avoir Commercial">Avoir Commercial</option>
          <option value="Attente MO">Attente MO</option>
        </select>
      </div>
      <div class="filter-group" style="flex:0 0 260px;">
  <label for="search-input">Recherche (client, mail, produit, r√©f, n¬∞ dossier...)</label>
  <input type="text" id="search-input" placeholder="Tapez pour filtrer...">
</div>
    </div>

    <div class="stats-row" id="stats-row"></div>

    <div class="layout-main">
      <div class="dossier-list" id="dossier-list"></div>

      <div class="detail-panel" id="detail-panel">
        <div class="empty-msg" id="detail-empty">
          S√©lectionnez un dossier dans la liste pour voir le d√©tail et le modifier.
        </div>
        <div id="detail-content" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- Modal fournisseur -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <h3>Envoyer le dossier au fournisseur</h3>
      <form id="fournisseur-form">
        <div class="modal-row">
          <label for="fournisseur-select">Fournisseur</label>
          <select id="fournisseur-select" name="fournisseur" required>
            <option value="">S√©lectionnez...</option>
            <option value="FEBI">FEBI</option>
            <option value="METELLI">METELLI</option>
            <option value="EFI">EFI</option>
            <option value="MAGNETI">MAGNETI</option>
            <option value="QH">QH</option>
            <option value="RIAL">RIAL</option>
            <option value="AUTOGAMMA">AUTOGAMMA</option>
            <option value="DELPHI">DELPHI</option>
            <option value="MS MOTORS">MS MOTORS</option>
            <option value="NGK">NGK</option>
            <option value="NRF">NRF</option>
            <option value="BOSCH FREINAGE">BOSCH FREINAGE</option>
            <option value="CORTECO">CORTECO</option>
            <option value="KYB">KYB</option>
            <option value="VERNET">VERNET</option>
            <option value="SEIM">SEIM</option>
            <option value="SCHAEFFLER">SCHAEFFLER</option>
          </select>
        </div>
        <div class="modal-row">
          <label for="fournisseur-message">Message au fournisseur (optionnel)</label>
          <textarea id="fournisseur-message" name="message" placeholder="Pr√©cisions compl√©mentaires..."></textarea>
        </div>
        <div class="modal-row">
          <label>Joindre des fichiers suppl√©mentaires (optionnel)</label>
          <input type="file" name="fichiers" id="fournisseur-files" multiple>
        </div>
        <div class="modal-row">
          <label>Formulaire fournisseur</label>
          <button type="button" class="btn secondary" id="btn-voir-formulaire">Ouvrir le formulaire</button>
        </div>
        <div class="modal-row">
          <label>Formulaire fournisseur (PDF) (optionnel)</label>
          <input type="file" name="formulaire" id="fournisseur-formulaire" accept="application/pdf">
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn secondary" id="btn-modal-cancel">Annuler</button>
          <button type="submit" class="btn">Envoyer</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let isSuperAdmin = false;
    let isAdmin = false;
    let magasinAdmin = null;

    let allDossiers = [];
    let ongletActif = "global";
    let dossierSelectionne = null;
    let docsBufferGlobal = [];
    let reponseBufferGlobal = [];


    function statutChip(statut) {
      const raw = (statut || "");
      const s = raw.toLowerCase();
      if (s === "enregistr√©") {
        return '<span class="statut-chip"><span class="statut-dot enregistre"></span>Enregistr√©</span>';
      }
      if (s === "accept√©") {
        return '<span class="statut-chip"><span class="statut-dot accepte"></span>Accept√©</span>';
      }
      if (s === "refus√©") {
        return '<span class="statut-chip"><span class="statut-dot refuse"></span>Refus√©</span>';
      }
      if (s === "avoir commercial" || s === "en attente d'info") {
        return '<span class="statut-chip"><span class="statut-dot info"></span>Avoir Commercial</span>';
      }
      if (s === "attente mo") {
        return '<span class="statut-chip"><span class="statut-dot attente-mo"></span>Attente MO</span>';
      }
      return raw || "";
    }

    function toggleSuperAdminUI() {
  const chip = document.getElementById("role-chip");
  if (chip) {
    if (isSuperAdmin) {
      chip.style.display = "inline-flex";
      chip.textContent = "Super Admin";
    } else if (isAdmin) {
      chip.style.display = "inline-flex";
      chip.textContent = "Admin";
    } else if (magasinAdmin) {
      chip.style.display = "inline-flex";
      chip.textContent = "Magasin : " + magasinAdmin;
    } else {
      chip.style.display = "none";
      chip.textContent = "";
    }
  }

  const magGroup = document.getElementById("magasin-filter-group");
  if (magGroup) {
    if (!isSuperAdmin && !isAdmin && magasinAdmin) {
      magGroup.style.display = "none";
    } else {
      magGroup.style.display = "";
    }
  }

  const exportBtn = document.getElementById("btn-export");
  if (exportBtn) {
    if (isSuperAdmin || isAdmin) {
      exportBtn.style.display = "inline-flex";
    } else {
      exportBtn.style.display = "none";
    }
  }
}

    function normaliserStatut(d) {
      if (d && d.statut === "en attente d'info") {
        d.statut = "Avoir Commercial";
      }
    }

    function chargerDossiers() {
  return fetch("/api/admin/dossiers")
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) data = [];
      data.forEach(normaliserStatut);
      allDossiers = data;
      construireOnglets();
      majStatsEtListe();
      return data;
    })
    .catch(err => {
      console.error("Erreur chargement dossiers:", err);
      const list = document.getElementById("dossier-list");
      if (list) {
        list.innerHTML =
          '<div class="empty-msg">Erreur de chargement des dossiers.</div>';
      }
    });
}

    function construireOnglets() {
      const tabsEl = document.getElementById("year-tabs");
      if (!tabsEl) return;
      tabsEl.innerHTML = "";

      const yearsSet = new Set();
      allDossiers.forEach(d => {
        if (!d.date) return;
        const dt = new Date(d.date);
        if (!isNaN(dt)) yearsSet.add(dt.getFullYear());
      });
      const years = Array.from(yearsSet).sort();

      const frag = document.createDocumentFragment();

      const tabGlobal = document.createElement("button");
      tabGlobal.type = "button";
      tabGlobal.className = "year-tab" + (ongletActif === "global" ? " active" : "");
      tabGlobal.textContent = "Tous";
      tabGlobal.addEventListener("click", () => {
        ongletActif = "global";
        majStatsEtListe();
        majOngletsActifs();
      });
      frag.appendChild(tabGlobal);

      years.forEach(y => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "year-tab" + (ongletActif === String(y) ? " active" : "");
        btn.textContent = y;
        btn.addEventListener("click", () => {
          ongletActif = String(y);
          majStatsEtListe();
          majOngletsActifs();
        });
        frag.appendChild(btn);
      });

      tabsEl.appendChild(frag);

      const currentYear = new Date().getFullYear();
      if (ongletActif === "global" && years.includes(currentYear)) {
        ongletActif = String(currentYear);
        majOngletsActifs();
      }
    }

    function majOngletsActifs() {
      const tabsEl = document.getElementById("year-tabs");
      if (!tabsEl) return;
      const buttons = tabsEl.querySelectorAll(".year-tab");
      buttons.forEach(btn => {
        const txt = btn.textContent.trim();
        if (ongletActif === "global" && txt === "Tous") {
          btn.classList.add("active");
        } else if (txt === ongletActif) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
    }

    function filtrerDossiers() {
      let liste = allDossiers.slice();

      if (ongletActif !== "global") {
        liste = liste.filter(d => {
          if (!d.date) return false;
          const dt = new Date(d.date);
          return !isNaN(dt) && String(dt.getFullYear()) === ongletActif;
        });
      }

      const monthInput = document.getElementById("month-filter");
      if (monthInput && monthInput.value) {
        const [y, m] = monthInput.value.split("-");
        if (y && m) {
          liste = liste.filter(d => {
            if (!d.date) return false;
            const dt = new Date(d.date);
            if (isNaN(dt)) return false;
            const yy = dt.getFullYear();
            const mm = dt.getMonth() + 1;
            return yy === Number(y) && mm === Number(m);
          });
        }
      }

      const magasinSel = document.getElementById("magasin-filter");
      const magVal = magasinSel ? magasinSel.value : "";
      if (magVal) {
        liste = liste.filter(d => d.magasin === magVal);
      } else if (!isSuperAdmin && !isAdmin && magasinAdmin) {
        liste = liste.filter(d => d.magasin === magasinAdmin);
      }

      const statutSel = document.getElementById("statut-filter");
      const statutVal = statutSel ? statutSel.value : "";
      if (statutVal) {
        liste = liste.filter(d => (d.statut || "") === statutVal);
      }

      const searchInput = document.getElementById("search-input");
      const q = searchInput ? searchInput.value.trim().toLowerCase() : "";
      if (q) {
        liste = liste.filter(d => {
          const fields = [
            d.numero_dossier,
            d.nom,
            d.email,
            d.magasin,
            d.marque_produit,
            d.produit_concerne,
            d.reference_piece,
            d.probleme_rencontre
          ];
          return fields.some(v =>
            v && String(v).toLowerCase().includes(q)
          );
        });
      }

      liste.sort((a, b) => {
        const da = a.date ? new Date(a.date).getTime() : 0;
        const db = b.date ? new Date(b.date).getTime() : 0;
        return db - da;
      });

      return liste;
    }

    function afficherCompteurs(dossiers) {
      const row = document.getElementById("stats-row");
      if (!row) return;
      const stats = [
        {
          label: "En attente de traitement ‚è≥",
          val: "enregistr√©",
          color: "orange"
        },
        {
          label: "Accept√©s üëç",
          val: "accept√©",
          color: "green"
        },
        {
          label: "Avoir Commercial üìù",
          val: "Avoir Commercial",
          color: "blue"
        },
        {
          label: "Attente MO üõ†Ô∏è",
          val: "Attente MO",
          color: "purple"
        },
        {
          label: "Refus√©s üëé",
          val: "refus√©",
          color: "red"
        }
      ];

      row.innerHTML = "";
      stats.forEach(s => {
        const count = dossiers.filter(d => (d.statut || "") === s.val).length;
        const card = document.createElement("div");
        card.className =
          "stat-card stat-" +
          s.color +
          (count > 0 ? "" : " stat-empty");
        card.innerHTML =
          '<span class="label">' +
          s.label +
          '</span><span class="value">' +
          count +
          "</span>";
        row.appendChild(card);
      });
    }

function renderListe() {
  const list = document.getElementById("dossier-list");
  if (!list) return;
  const filtered = filtrerDossiers();
  afficherCompteurs(filtered);

  if (!filtered.length) {
    list.innerHTML =
      '<div class="empty-msg">Aucun dossier ne correspond √† vos filtres.</div>';
    return;
  }

  const frag = document.createDocumentFragment();
  filtered.forEach(d => {
    const row = document.createElement("div");
    row.className =
      "dossier-row" +
      (dossierSelectionne && dossierSelectionne.id === d.id
        ? " active"
        : "");
    row.dataset.id = d.id;

    const colNum = document.createElement("div");
    colNum.className = "dossier-num";
    colNum.textContent = d.numero_dossier || "-";

    const left = document.createElement("div");
    left.className = "dossier-main";

    const title = document.createElement("div");
    title.className = "dossier-title";
    const dateStr = d.date
      ? new Date(d.date).toLocaleDateString("fr-FR")
      : "";
    title.textContent =
      (d.nom || "Client") + (dateStr ? " ‚Äî " + dateStr : "");

    const sub = document.createElement("div");
sub.className = "dossier-sub";

const parts = [];

if (d.produit_concerne) {
  parts.push("Produit : " + d.produit_concerne);
}

if (d.marque_produit) {
  parts.push("Marque du produit : " + d.marque_produit);
}

if (d.reference_piece) {
  parts.push("R√©f : " + d.reference_piece);
}

sub.textContent = parts.join(" ‚Äî ");

    left.appendChild(title);
    left.appendChild(sub);

    const mid = document.createElement("div");
mid.innerHTML =
  '<span class="badge-magasin">' +
  (d.magasin || "‚Äî") +
  "</span>";

    const right = document.createElement("div");
    right.innerHTML = statutChip(d.statut);

    row.appendChild(colNum);
    row.appendChild(left);
    row.appendChild(mid);
    row.appendChild(right);

    row.addEventListener("click", () => {
      dossierSelectionne = d;
      document
        .querySelectorAll(".dossier-row.active")
        .forEach(r => r.classList.remove("active"));
      row.classList.add("active");
      afficherDetail(d);
    });

    frag.appendChild(row);
  });

  list.innerHTML = "";
  list.appendChild(frag);
}

    function majStatsEtListe() {
      renderListe();
    }

    function renderFilesList(arr, title) {
  if (!arr || !arr.length) return "";
  let html = '<div class="detail-field-label">' + title + "</div>";
  html += '<div class="detail-files-list">';
  arr.forEach(f => {
    const name = f.original || f.url || "fichier";
    const urlEnc = encodeURIComponent(f.url || "");

    if (title === "Documents ajout√©s au dossier") {
      html +=
        '<span class="file-pill">' +
          '<a href="/download/' + urlEnc + '" target="_blank" title="T√©l√©charger">' +
            name +
          "</a>" +
          ' <button type="button" class="file-remove" onclick="supprimerDocumentLocal(event)" title="Retirer de l\'affichage">‚úï</button>' +
        "</span>";
    } else {
      html +=
        '<a class="file-pill" href="/download/' + urlEnc + '" target="_blank" title="T√©l√©charger">' +
          name +
        "</a>";
    }
  });
  html += "</div>";
  return html;
}
function supprimerDocumentLocal(evt) {
  const pill = evt.target.closest('.file-pill');
  if (pill) {
    pill.remove();
  }
}

    function afficherDetail(d) {
      const empty = document.getElementById("detail-empty");
      const content = document.getElementById("detail-content");
      if (!content || !empty) return;
      empty.style.display = "none";
      content.style.display = "block";

      const dateStr = d.date
        ? new Date(d.date).toLocaleDateString("fr-FR")
        : "";
      const numero = d.numero_dossier || "";
      const statutHtml = statutChip(d.statut);

      const filesHtml = renderFilesList(d.files, "Pi√®ces jointes client");
      const repFilesHtml = renderFilesList(
        d.reponseFiles,
        "Documents envoy√©s au client"
      );
      const docsAjHtml = renderFilesList(
        d.documentsAjoutes,
        "Documents ajout√©s au dossier"
      );

      const attenteMoTexte = ((d.statut || "").toLowerCase() === "attente mo") ? "Oui" : "Non";

  content.innerHTML =
    '<div class="detail-header">' +
    '<div>' +
    '<div class="detail-header-title">Dossier ' +
    (numero ? "#" + numero : "") +
    "</div>" +
    '<div class="detail-header-sub">' +
    (d.nom || "Client") +
    (d.email ? " ‚Äî " + d.email : "") +
    (dateStr ? " ‚Äî Cr√©√© le " + dateStr : "") +
    "</div>" +
    "</div>" +
    '<div>' +
    statutHtml +
    "</div>" +
    "</div>" +
    '<div class="detail-body">' +
    '<div class="detail-grid">' +
    '<div><div class="detail-field-label">Magasin</div><div class="detail-field-value">' +
    (d.magasin || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">Produit</div><div class="detail-field-value">' +
    (d.produit_concerne || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">Marque du produit</div><div class="detail-field-value">' +
    (d.marque_produit || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">R√©f√©rence pi√®ce</div><div class="detail-field-value">' +
    (d.reference_piece || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">Immatriculation</div><div class="detail-field-value">' +
    (d.immatriculation || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">Probl√®me rencontr√©</div><div class="detail-field-value">' +
    (d.probleme_rencontre || "")
      .replace(/\r\n/g, "<br>")
      .replace(/\r/g, "<br>") +
    "</div></div>" +
    "</div>" +
	
	'<div class="detail-grid">' +
    '<div><div class="detail-field-label">Quantit√© pos√©e</div><div class="detail-field-value">' +
    (d.quantite_posee || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">Marque v√©hicule</div><div class="detail-field-value">' +
    (d.marque_vehicule || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">Mod√®le v√©hicule</div><div class="detail-field-value">' +
    (d.modele_vehicule || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">Num√©ro de s√©rie</div><div class="detail-field-value">' +
    (d.num_serie || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">1√®re immatriculation</div><div class="detail-field-value">' +
    (d.premiere_immat || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">Date de pose</div><div class="detail-field-value">' +
    (d.date_pose || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">Date du constat</div><div class="detail-field-value">' +
    (d.date_constat || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">Kilom√©trage √† la pose</div><div class="detail-field-value">' +
    (d.km_pose || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">Kilom√©trage au constat</div><div class="detail-field-value">' +
    (d.km_constat || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">N¬∞ BL 1√®re Vente</div><div class="detail-field-value">' +
    (d.bl_pose || "") +
    "</div></div>" +
    '<div><div class="detail-field-label">N¬∞ BL 2√®me Vente</div><div class="detail-field-value">' +
    (d.bl_constat || "") +
    "</div></div>" +
    "</div>" +

    docsAjHtml +

    filesHtml +
    repFilesHtml +
    "</div>" +
    construireFormulaireEdition(d);

  const editForm = document.getElementById("edit-form");
  if (editForm) {
    const attToggle = editForm.querySelector("input[name='attente_mo']");
    const statutSelIn = editForm.querySelector("select[name='statut']");

    if (attToggle && statutSelIn) {
      attToggle.addEventListener("change", () => {
        if (attToggle.checked) {
          statutSelIn.value = "Attente MO";
        } else {
          if (statutSelIn.value === "Attente MO") {
            statutSelIn.value = "enregistr√©";
          }
        }
      });

      statutSelIn.addEventListener("change", () => {
        if (statutSelIn.value === "Attente MO") {
          attToggle.checked = true;
        } else if (statutSelIn.value === "accept√©") {
          attToggle.checked = false;
        }
      });
    }

      docsBufferGlobal = [];
      reponseBufferGlobal = [];

      const docsInput = document.querySelector('#edit-form input[name="documentsAjoutes"]');
      const docsList = document.getElementById("docs-ajoutes-buffer");
      const repInput = document.querySelector('#edit-form input[name="reponseFiles"]');
      const repList = document.getElementById("reponse-files-buffer");

      function renderBuffer(listEl, buffer) {
        if (!listEl) return;
        listEl.innerHTML = "";
        buffer.forEach((file, idx) => {
          const li = document.createElement("li");
          const span = document.createElement("span");
          span.textContent = file.name;
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "file-remove";
          btn.textContent = "‚úï";
          btn.title = "Retirer ce fichier";
          btn.addEventListener("click", () => {
            buffer.splice(idx, 1);
            renderBuffer(listEl, buffer);
          });
          li.appendChild(span);
          li.appendChild(btn);
          listEl.appendChild(li);
        });
      }

      if (docsInput && docsList) {
        docsInput.addEventListener("change", () => {
          Array.from(docsInput.files).forEach(f => docsBufferGlobal.push(f));
          docsInput.value = "";
          renderBuffer(docsList, docsBufferGlobal);
        });
        renderBuffer(docsList, docsBufferGlobal);
      }

      if (repInput && repList) {
        repInput.addEventListener("change", () => {
          Array.from(repInput.files).forEach(f => reponseBufferGlobal.push(f));
          repInput.value = "";
          renderBuffer(repList, reponseBufferGlobal);
        });
        renderBuffer(repList, reponseBufferGlobal);
      }
  }
}


    function construireFormulaireEdition(d) {
      const selectedEnr = d.statut === "enregistr√©";
      const selectedAcc = d.statut === "accept√©";
      const selectedRef = d.statut === "refus√©";
      const selectedAvoir = d.statut === "Avoir Commercial";
      const selectedMO = d.statut === "Attente MO";

      const numeroAvoirValue = d.numero_avoir
        ? String(d.numero_avoir).replace(/"/g, "&quot;")
        : "";
      const reponseValue = d.reponse
        ? String(d.reponse).replace(/</g, "&lt;").replace(/>/g, "&gt;")
        : "";
      const attenteMoChecked = ((d.statut || "").toLowerCase() === "attente mo") ? " checked" : "";

      return (
        '<form class="detail-form" id="edit-form">' +
        '<div class="detail-form-row">' +
        '<div class="detail-form-group">' +
        "<label>Num√©ro d'avoir</label>" +
        '<input type="text" name="numero_avoir" value="' +
        numeroAvoirValue +
        '">' +
        "</div>" +
        '<div class="detail-form-group">' +
"<label>Attente MO</label>" +
'<div class="attente-mo-check">' +
  '<label class="switch">' +
    '<input type="checkbox" id="attente_mo" name="attente_mo"' +
    attenteMoChecked +
    ">" +
    '<span class="slider"></span>' +
  "</label>" +
  '<span>Dossier en "Attente MO"</span>' +
"</div>" +
"</div>" +
        "</div>" +

        '<div class="detail-form-group" id="docs-group">' +
        "<label>Documents ajout√©s au dossier (non envoy√©s au client)</label>" +
        '<input type="file" name="documentsAjoutes" multiple>' +
        '<ul class="file-list" id="docs-ajoutes-buffer"></ul>' +
        "</div>" +

        '<hr class="detail-separator">' +
        '<div class="detail-warning-title">‚ö†Ô∏èTOUTE MODIFICATION DANS CE CADRE EST ENVOY√âE PAR MAIL AU CLIENT‚ö†Ô∏è</div>' +

        '<div class="detail-form-row">' +
        '<div class="detail-form-group">' +
        "<label>Statut</label>" +
        '<select name="statut">' +
        '<option value="enregistr√©"' +
        (selectedEnr ? " selected" : "") +
        ">Enregistr√©</option>" +
        '<option value="accept√©"' +
        (selectedAcc ? " selected" : "") +
        ">Accept√©</option>" +
        '<option value="refus√©"' +
        (selectedRef ? " selected" : "") +
        ">Refus√©</option>" +
        '<option value="Avoir Commercial"' +
        (selectedAvoir ? " selected" : "") +
        ">Avoir Commercial</option>" +
        '<option value="Attente MO"' +
        (selectedMO ? " selected" : "") +
        ">Attente MO</option>" +
        "</select>" +
        "</div>" +
        "</div>" +

        '<div class="detail-form-group reponse-client">' +
        "<label>R√©ponse au client</label>" +
        '<textarea name="reponse" placeholder="Texte de r√©ponse au client...">' +
        reponseValue +
        "</textarea>" +
        "</div>" +

        '<div class="detail-form-group" id="reponse-group">' +
        "<label>Pi√®ces jointes pour le client (envoi mail)</label>" +
        '<input type="file" name="reponseFiles" multiple>' +
        '<ul class="file-list" id="reponse-files-buffer"></ul>' +
        "</div>" +

        '<div class="detail-buttons">' +
        '<button type="submit" class="btn">üíæ Enregistrer</button>' +
        '<button type="button" class="btn secondary" id="btn-imprimer-dossier">üñ®Ô∏è Imprimer</button>' +
        '<button type="button" class="btn secondary" id="btn-modifier-dossier">üìù Modifier dossier</button>' +
        ((isSuperAdmin || isAdmin)
          ? '<button type="button" class="btn secondary" id="btn-envoyer-fournisseur">üì§ Envoyer au fournisseur</button>'
          : "") +
        (isSuperAdmin
          ? '<button type="button" class="btn danger" id="btn-supprimer-dossier">üóëÔ∏è Supprimer le dossier</button>'
          : "") +
        "</div>" +
        "</form>"
      );
    }

    function onSubmitEditForm(e) {
      e.preventDefault();
      if (!dossierSelectionne) return;
      const form = e.target;
      const id = dossierSelectionne.id;

      const attCheckbox = form.querySelector("input[name='attente_mo']");
      const statutSel = form.querySelector("select[name='statut']");
      if (attCheckbox && statutSel) {
        if (attCheckbox.checked) {
          statutSel.value = "Attente MO";
        } else if (statutSel.value === "Attente MO") {
          statutSel.value = "enregistr√©";
        }
      }

      const fd = new FormData(form);

      (docsBufferGlobal || []).forEach(f => {
        fd.append("documentsAjoutes", f);
      });
      (reponseBufferGlobal || []).forEach(f => {
        fd.append("reponseFiles", f);
      });

       fetch("/api/admin/dossier/" + encodeURIComponent(id), {
    method: "POST",
    body: fd
  })
    .then(r => r.json())
    .then(json => {
  if (!json || !json.success) {
    alert("Erreur lors de la mise √† jour : " + (json && json.message ? json.message : ""));
  } else {
    alert("Enregistrement effectu√©.");

    const currentId = id;

    chargerDossiers().then(() => {
      const updated = allDossiers.find(d => d.id === currentId);
      if (updated) {
        dossierSelectionne = updated;
        afficherDetail(updated);

        const row = document.querySelector(
          '.dossier-row[data-id="' + currentId + '"]'
        );
        if (row) {
          document
            .querySelectorAll(".dossier-row.active")
            .forEach(r => r.classList.remove("active"));
          row.classList.add("active");
        }
      }
    });
  }
})
    .catch(err => {
      console.error(err);
      alert("Erreur r√©seau lors de la mise √† jour.");
    });
}

    function supprimerDossier() {
      if (!dossierSelectionne) return;
      if (!confirm("Supprimer d√©finitivement ce dossier ?")) return;
      const id = dossierSelectionne.id;
      fetch("/api/admin/dossier/" + encodeURIComponent(id), {
        method: "DELETE",
        headers: {
          "x-superadmin": isSuperAdmin ? "1" : ""
        }
      })
        .then(r => r.json())
        .then(json => {
          if (!json || !json.success) {
            alert("Erreur lors de la suppression : " + (json && json.message ? json.message : ""));
          }
          dossierSelectionne = null;
          document.getElementById("detail-content").style.display = "none";
          document.getElementById("detail-empty").style.display = "block";
          chargerDossiers();
        })
        .catch(err => {
          console.error(err);
          alert("Erreur r√©seau lors de la suppression.");
        });
    }

    function ouvrirModalFournisseur() {
      if (!dossierSelectionne) return;
      const backdrop = document.getElementById("modal-backdrop");
      if (backdrop) backdrop.style.display = "flex";
      const form = document.getElementById("fournisseur-form");
      if (form) form.reset();
    }

    function fermerModalFournisseur() {
      const backdrop = document.getElementById("modal-backdrop");
      if (backdrop) backdrop.style.display = "none";
    }

    function ouvrirModifierDossier() {
      if (!dossierSelectionne) return;
      const back = document.getElementById('edit-modal-backdrop');
      const form = document.getElementById('modifier-form');
      if (!back || !form) return;
      const d = dossierSelectionne;
      form.nom.value = d.nom || '';
      form.email.value = d.email || '';
      form.magasin.value = d.magasin || '';
      form.marque_produit.value = d.marque_produit || '';
      form.produit_concerne.value = d.produit_concerne || '';
      form.reference_piece.value = d.reference_piece || '';
      form.quantite_posee.value = d.quantite_posee || '';
      form.immatriculation.value = d.immatriculation || '';
      form.marque_vehicule.value = d.marque_vehicule || '';
      form.modele_vehicule.value = d.modele_vehicule || '';
      form.num_serie.value = d.num_serie || '';
      form.premiere_immat.value = d.premiere_immat || '';
      form.date_pose.value = d.date_pose || '';
      form.date_constat.value = d.date_constat || '';
      form.km_pose.value = d.km_pose || '';
      form.km_constat.value = d.km_constat || '';
      form.bl_pose.value = d.bl_pose || '';
      form.bl_constat.value = d.bl_constat || '';
      form.probleme_rencontre.value = d.probleme_rencontre || '';
      const dataList = document.getElementById('magasins-list');
      if (dataList) {
        const opts = Array.from(new Set(allDossiers.map(x => x.magasin).filter(Boolean)))
          .sort((a,b) => a.localeCompare(b,'fr'))
          .map(m => '<option value="' + m + '"></option>')
          .join('');
        dataList.innerHTML = opts;
      }
      back.style.display = 'flex';
    }

    function fermerModifierDossier() {
      const back = document.getElementById('edit-modal-backdrop');
      if (back) back.style.display = 'none';
    }

    function onSubmitModifierForm(e) {
      e.preventDefault();
      if (!dossierSelectionne) return;
      const id = dossierSelectionne.id;
      const form = e.target;
      const data = {};
      new FormData(form).forEach((v, k) => { data[k] = v; });
      fetch('/api/admin/completer-dossier/' + encodeURIComponent(id), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(resp => {
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return resp.json().catch(() => { throw new Error('invalid_json'); });
        }).then(json => {
  if (!json || !json.success) {
    alert('Erreur lors de la mise √† jour : ' + (json && json.message ? json.message : ''));
    return;
  }

  alert('Enregistrement effectu√©.');

  const currentId = id;

  fermerModifierDossier();

  chargerDossiers().then(() => {
    const updated = allDossiers.find(d => d.id === currentId);
    if (updated) {
      dossierSelectionne = updated;
      afficherDetail(updated);

      const row = document.querySelector(
        '.dossier-row[data-id="' + currentId + '"]'
      );
      if (row) {
        document
          .querySelectorAll(".dossier-row.active")
          .forEach(r => r.classList.remove("active"));
        row.classList.add("active");
      }
    }
  });
}).catch(err => {
  console.error(err);
  alert(err.message || 'Erreur r√©seau');
});
}

    function onSubmitFournisseurForm(e) {
      e.preventDefault();
      if (!dossierSelectionne) return;
      const id = dossierSelectionne.id;
      const form = e.target;
      const fd = new FormData(form);
      fetch("/api/admin/envoyer-fournisseur/" + encodeURIComponent(id), {
        method: "POST",
        body: fd
      })
        .then(r => r.json())
        .then(json => {
          if (!json || !json.success) {
            alert("Erreur lors de l'envoi au fournisseur : " + (json && json.message ? json.message : ""));
          } else {
            alert("Dossier envoy√© au fournisseur.");
          }
          fermerModalFournisseur();
        })
        .catch(err => {
          console.error(err);
          alert("Erreur r√©seau lors de l'envoi au fournisseur.");
          fermerModalFournisseur();
        });
    }

    function exportExcel() {
      window.location.href = "/api/admin/export-excel";
    }

    
    function ouvrirFormulaireFournisseur() {
      const fournisseurSelect = document.getElementById("fournisseur-select");
      if (!fournisseurSelect) return;
      const supVal = fournisseurSelect.value;
      if (!supVal) {
        alert("Veuillez d'abord choisir un fournisseur.");
        return;
      }

      const resourceMap = {
        "FEBI":       { type: "pdf", file: "FICHE_GARANTIE_FEBI.pdf" },
        "METELLI":    { type: "pdf", file: "formulaire_garantie_metelli.pdf" },
        "EFI":        { type: "pdf", file: "Formulaire_EFI.pdf" },
        "MAGNETI":    { type: "pdf", file: "FORMULAIRE_MAGNETI.pdf" },
        "QH":         { type: "pdf", file: "FORMULAIRE_QH.pdf" },
        "RIAL":       { type: "pdf", file: "DEMANDE_RIAL.pdf" },
        "AUTOGAMMA":  { type: "pdf", file: "Formulaire_ AUTOGAMMA.pdf" },
        "DELPHI":     { type: "pdf", file: "Formulaire_delphi.pdf" },
        "MS MOTORS":  { type: "pdf", file: "FORMULAIRE_ms.pdf" },
        "NGK":        { type: "pdf", file: "Formulaire_ngk.pdf" },
        "NRF":        { type: "pdf", file: "Formulaire_nrf.pdf" },
        "SEIM":       { type: "pdf", file: "Formulaire_SEIM.pdf" },
        "SCHAEFFLER": { 
          type: "url",
          link: "https://docs.google.com/spreadsheets/d/15mXFV5Xz-lo0Yg7ba4pAZdfPTGJxbZzY/edit?pli=1&gid=156879081#gid=156879081"
        }
      };

      const res = resourceMap[supVal];
      if (!res) {
        alert("Aucun formulaire n'est configur√© pour ce fournisseur.");
        return;
      }

      if (res.type === "pdf") {
        const pdfUrl = "/templates/" + res.file;
        const formWin = window.open("", "_blank", "width=800,height=750");
        if (!formWin) return;
        formWin.document.open();
        formWin.document.write(`
          <html><head><meta charset="UTF-8"><title>Formulaire ${supVal}</title></head>
          <body style="margin:0;padding:0;">
            <embed src="${pdfUrl}" type="application/pdf" width="100%" height="100%">
          </body></html>
        `);
        formWin.document.close();
      } else if (res.type === "url") {
        window.open(res.link, "_blank");
      }
    }


function initEvents() {
      const loginBtn = document.getElementById("login-btn");
      const loginInput = document.getElementById("admin-password");
      const loginMsg = document.getElementById("login-msg");

      function tryLogin() {
        const pw = loginInput.value;
        loginMsg.textContent = "";
        fetch("/api/admin/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ password: pw })
        })
          .then(r => r.json())
          .then(json => {
            if (json && json.success) {
              isSuperAdmin = !!json.isSuper;
              isAdmin = !!json.isAdmin;
              magasinAdmin = json.magasin || null;
              document.getElementById("login").style.display = "none";
              document.getElementById("admin-content").style.display = "block";
              toggleSuperAdminUI();
              chargerDossiers();
            } else {
              loginMsg.textContent =
                (json && json.message) || "Mot de passe incorrect.";
            }
          })
          .catch(err => {
            console.error(err);
            loginMsg.textContent = "Erreur r√©seau.";
          });
      }

      loginBtn.addEventListener("click", tryLogin);
      loginInput.addEventListener("keydown", e => {
        if (e.key === "Enter") tryLogin();
      });

      document.getElementById("btn-export").addEventListener("click", exportExcel);

      ["month-filter", "magasin-filter", "statut-filter", "search-input"].forEach(
        id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("input", () => majStatsEtListe());
          if (el.tagName === "SELECT" || id === "month-filter") {
            el.addEventListener("change", () => majStatsEtListe());
          }
        }
      );

      document
        .getElementById("detail-panel")
        .addEventListener("submit", e => {
          if (e.target && e.target.id === "edit-form") {
            onSubmitEditForm(e);
          }
        });

      document
        .getElementById("detail-panel")
        .addEventListener("click", e => {
          const t = e.target;
          if (t.id === "btn-supprimer-dossier") {
            supprimerDossier();
          } else if (t.id === "btn-envoyer-fournisseur") {
            ouvrirModalFournisseur();
          } else if (t.id === "btn-imprimer-dossier") {
            if (dossierSelectionne && dossierSelectionne.id) {
              voirDossier(dossierSelectionne.id);
            }
          } else if (t.id === "btn-modifier-dossier") {
            ouvrirModifierDossier();
          }
        });

      document
        .getElementById("btn-modal-cancel")
        .addEventListener("click", fermerModalFournisseur);
      document
        .getElementById("modal-backdrop")
        .addEventListener("click", e => {
          if (e.target.id === "modal-backdrop") fermerModalFournisseur();
        });
      document
        .getElementById("fournisseur-form")
        .addEventListener("submit", onSubmitFournisseurForm);
      const fournisseurSelect = document.getElementById("fournisseur-select");
      const formulaireBtn = document.getElementById("btn-voir-formulaire");
      if (fournisseurSelect && formulaireBtn) {
        const HIDE_FORM_FOR = new Set(["BOSCH FREINAGE", "CORTECO", "KYB", "VERNET"]);
        const updateFormulaireVisibility = () => {
          const val = fournisseurSelect.value || "";
          if (!val || HIDE_FORM_FOR.has(val)) {
            formulaireBtn.style.display = "none";
          } else {
            formulaireBtn.style.display = "inline-flex";
          }
        };
        fournisseurSelect.addEventListener("change", updateFormulaireVisibility);
        updateFormulaireVisibility();

        formulaireBtn.addEventListener("click", (e) => {
          e.preventDefault();
          ouvrirFormulaireFournisseur();
        });
      }

      const modAnnuler = document.getElementById('modifier-annuler');
      const editBackdrop = document.getElementById('edit-modal-backdrop');
      const modForm = document.getElementById('modifier-form');
      if (modAnnuler) {
        modAnnuler.addEventListener('click', fermerModifierDossier);
      }
      if (editBackdrop) {
        editBackdrop.addEventListener('click', e => {
          if (e.target.id === 'edit-modal-backdrop') fermerModifierDossier();
        });
      }
      if (modForm) {
        modForm.addEventListener('submit', onSubmitModifierForm);
      }

    }

function formatDateFRshort(val) {
    if (!val) return "";
    let d = typeof val === "string" ? new Date(val) : val;
    if (typeof val === "string" && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
      let [y, m, d2] = val.split("-");
      return `${d2}/${m}/${y.slice(2)}`;
    }
    if (!isNaN(d)) {
      let day = ("0"+d.getDate()).slice(-2);
      let month = ("0"+(d.getMonth()+1)).slice(-2);
      let year = d.getFullYear().toString().slice(-2);
      return `${day}/${month}/${year}`;
    }
    return val;
  }

function voirDossier(id) {
    let d = allDossiers.find(x=>x.id===id);
    if (!d) return alert("Dossier introuvable !");
    let logoUrl = "https://raw.githubusercontent.com/docudurand/warrantydurand/main/DSG.png";
    let dateCreation = d.date ? new Date(d.date).toLocaleDateString("fr-FR") : "";
    let clientNom = (d.nom||"Client").replace(/[^a-zA-Z0-9]/g, "_").toUpperCase();
    let dateStr = "";
    if (d.date) {
      let dt = new Date(d.date);
      if (!isNaN(dt)) {
        dateStr = dt.toISOString().slice(0,10);
      }
    }
    let nomFichier = `${clientNom}${dateStr ? "_" + dateStr : ""}`;
    let fichiersDocs = [].concat(
      d.files||[],
      d.documentsAjoutes||[],
      d.reponseFiles||[]
    ).filter(f => f && f.url);
    fichiersDocs = fichiersDocs.filter((f, i, arr) =>
      arr.findIndex(x => x.url === f.url) === i
    );

    let detailHtml = `
      <html><head>
      <meta charset="UTF-8">
      <title>${nomFichier}</title>
      <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background:#f9fafb; margin:0; }
        .fiche-header { display:flex; align-items:center; gap:18px; margin-bottom:18px; }
        .fiche-header img { height:62px; border-radius:11px; box-shadow:0 2px 12px #0001; background:#fff;}
        .fiche-header .magasin-title { font-size:1.22em; font-weight:600; color:#17537a; }
        .fiche-date { margin-left:auto; font-size:1.08em; color:#444; font-weight:bold;}
        .fiche-table { max-width:760px; margin:30px auto; background:#fff; border-radius:10px; border:1px solid #e5e7eb; padding:18px 24px 14px 24px; }
        .fiche-table table { width:100%; border-collapse:collapse; }
        .fiche-table th, .fiche-table td { text-align:left; padding:8px 10px; border:none; }
        .fiche-table th { color:#194e72; font-size:1.06em; text-align:left; width:220px; vertical-align:top;}
        .fiche-table tr { border-bottom:1px solid #f0f0f0;}
        .fiche-title { font-weight:bold; color:#006e90; padding-top:24px; font-size:1.08em;}
        .fiche-actions { text-align:right; margin-bottom:14px;}
        .print-btn { background:#006e90; color:#fff; border:none; padding:9px 22px; border-radius:7px; font-size:1.07em; font-weight:600; cursor:pointer; margin-left:7px;}
        .print-btn:hover { background:#1780b0; }
        @media print {
          .print-btn { display:none !important; }
          body { background: #fff; }
          .fiche-table { box-shadow: none; border:1px solid #888;}
          .fiche-header { padding-top:10px; }
          .hide-print { display:none !important; }
          .fiche-date { display:block !important; position:absolute; top:24px; right:40px; font-size:1.09em;}
        }
        .statut-chip { display:inline-flex; align-items:center; gap:6px; font-weight:600; font-size:1em;}
        .statut-dot { display:inline-block; width:15px; height:15px; border-radius:50%; margin-right:2px; }
        .statut-dot.enregistre { background:#f8a900; border: 2px solid #f7ce65; }
        .statut-dot.accepte { background:#16c11c; border: 2px solid #a6ebba; }
        .statut-dot.refuse { background:#bb1810; border: 2px solid #f49e9e; }
        .statut-dot.info { background:#1978d2; border: 2px solid #93c7fa; }
        .statut-dot.attente-mo { background:#7d3cff; border: 2px solid #cbb6ff; }
        .pj-img { max-width:180px; max-height:120px; display:block; margin-bottom:6px; border-radius:5px; box-shadow:0 2px 6px #0002; }
      </style>
      </head><body>
      <div class="fiche-header">
        <img src="${logoUrl}" alt="Logo DSG">
        <span class="magasin-title">${d.magasin||""}</span>
        <span class="fiche-date" style="margin-left:auto;">Cr√©√© le : ${dateCreation}<br>Num√©ro de dossier : ${d.numero_dossier || ''}</span>
      </div>
      <div class="fiche-table">
        <div class="fiche-actions">
          <button class="print-btn" onclick="renameAndPrint('${nomFichier}')">üñ®Ô∏è Imprimer</button>
        </div>
        <table>
          <tr><th>Nom du client</th><td>${d.nom||""}</td></tr>
          <tr><th>Email</th><td>${d.email||""}</td></tr>
          <tr><th>Magasin</th><td>${d.magasin||""}</td></tr>
          <tr class="hide-print"><td colspan="2" class="fiche-title">Produit</td></tr>
          <tr><th>Marque du produit</th><td>${d.marque_produit||""}</td></tr>
          <tr><th>Produit concern√©</th><td>${d.produit_concerne||""}</td></tr>
          <tr><th>R√©f√©rence de la pi√®ce</th><td>${d.reference_piece||""}</td></tr>
          <tr><th>Quantit√© pos√©e</th><td>${d.quantite_posee||""}</td></tr>
          <tr class="hide-print"><td colspan="2" class="fiche-title">V√©hicule</td></tr>
          <tr><th>Immatriculation</th><td>${d.immatriculation||""}</td></tr>
          <tr><th>Marque</th><td>${d.marque_vehicule||""}</td></tr>
          <tr><th>Mod√®le</th><td>${d.modele_vehicule||""}</td></tr>
          <tr><th>Num√©ro de s√©rie</th><td>${d.num_serie||""}</td></tr>
          <tr><th>1√®re immatriculation</th><td>${formatDateFRshort(d.premiere_immat)}</td></tr>
          <tr class="hide-print"><td colspan="2" class="fiche-title">Probl√®me</td></tr>
          <tr><th>Date de pose</th><td>${formatDateFRshort(d.date_pose)}</td></tr>
          <tr><th>Date du constat</th><td>${formatDateFRshort(d.date_constat)}</td></tr>
          <tr><th>Kilom√©trage √† la pose</th><td>${d.km_pose||""}</td></tr>
          <tr><th>Kilom√©trage au constat</th><td>${d.km_constat||""}</td></tr>
          <tr><th>N¬∞ BL 1√®re Vente</th><td>${d.bl_pose||""}</td></tr>
          <tr><th>N¬∞ BL 2√®me Vente</th><td>${d.bl_constat||""}</td></tr>
          <tr><th>Probl√®me rencontr√©</th><td>${d.probleme_rencontre||""}</td></tr>
          <tr class="hide-print"><th>Statut</th><td>${statutChip(d.statut)}</td></tr>
          <tr><th>R√©ponse</th><td>${d.reponse ? d.reponse.replace(/\n/g,"<br>") : ""}</td></tr>
          <tr><th>Num√©ro d'avoir (interne)</th><td>${d.numero_avoir||""}</td></tr>
          <tr class="hide-print"><th>Documents ajout√©s</th>
            <td>${
              fichiersDocs.length ? fichiersDocs.map(f=>{
                let ext = (f.original||"").split('.').pop().toLowerCase();
                if(["jpg","jpeg","png","gif","webp","bmp"].includes(ext)){
                  return `<a href="javascript:void(0)" onclick="window.opener.ouvrirDocumentDansPopup('/download/${f.url}','${f.original}')"><img src="/download/${f.url}" class="pj-img"></a>`;
                } else {
                  return `<a href="javascript:void(0)" onclick="window.opener.ouvrirDocumentDansPopup('/download/${f.url}','${f.original}')">${f.original||""}</a>`;
                }
              }).join("<br>") : ""
            }</td>
          </tr>
        </table>
      </div>
      <script>
        function renameAndPrint(filename) {
          var oldTitle = document.title;
          document.title = filename;
          window.print();
          setTimeout(function() {
            document.title = oldTitle;
          }, 1500);
        }
        window.onbeforeprint = function() {
          document.title = "${nomFichier}";
        };
        window.onafterprint = function() {
          setTimeout(function(){
            document.title = "${nomFichier}";
          }, 500);
        };
      <\/script>
      </body></html>
    `;
    let win = window.open("", "_blank", "width=820,height=900");
    win.document.write(detailHtml);
    win.document.close();
  }
document.addEventListener("DOMContentLoaded", initEvents);
  </script>
</body>
</html>