<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DSG – Administration</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <!-- Header / Navigation -->
    <header class="navbar">
      <div class="container nav-content">
        <a href="index.html" class="brand">
          <img src="./images/logo1.png" alt="Logo DSG" class="logo" />
          <span>Durand Services Garantie</span>
        </a>
        <nav>
          <ul class="nav-links">
            <!-- Lien vers la page de demande -->
            <li><a href="demande.html">Faire une demande</a></li>
            <!-- Lien vers la page de suivi -->
            <li><a href="suivi.html">Suivre une demande</a></li>
            <!-- Aucun lien Admin n'est affiché pour éviter la navigation depuis Wix -->
          </ul>
        </nav>
      </div>
    </header>

    <section class="page-header">
      <div class="container">
        <h1>Interface d'administration</h1>
        <p>Accédez aux demandes de garantie, répondez aux clients et joignez des documents.</p>
      </div>
    </section>

    <section class="form-section">
      <div class="container">
        <!-- Password prompt -->
        <div id="loginSection" class="login-section">
          <p>Veuillez saisir le mot de passe administrateur pour accéder à l'interface.</p>
          <input type="password" id="adminPassword" placeholder="Mot de passe" />
          <button id="loginButton" class="btn primary">Valider</button>
          <p id="loginError" class="error"></p>
        </div>
        <!-- Admin panel hidden by default -->
        <div id="adminPanel" class="admin-panel hidden">
          <div class="filters">
            <select id="filterStatut">
              <option value="">Tous les statuts</option>
              <option value="enregistré">Enregistré</option>
              <option value="en attente">En attente</option>
              <option value="pris en charge">Pris en charge</option>
              <option value="accepté">Accepté</option>
              <option value="refusé">Refusé</option>
            </select>
            <select id="filterMagasinAdmin">
              <option value="">Tous les magasins</option>
              <option value="Annemasse">Annemasse</option>
              <option value="Bourgoin-Jallieu">Bourgoin-Jallieu</option>
              <option value="Chasse-sur-Rhone">Chasse-sur-Rhône</option>
              <option value="Chassieu">Chassieu</option>
              <option value="Gleize">Gleizé</option>
              <option value="La Motte-Servolex">La Motte-Servolex</option>
              <option value="Les Echets">Les Échets</option>
              <option value="Pavi">Pavi</option>
              <option value="Rives">Rives</option>
              <option value="Saint-Egreve">Saint-Égrève</option>
              <option value="Saint-Jean-Bonnefonds">Saint-Jean-Bonnefonds</option>
              <option value="Saint-Martin-d'heres">Saint-Martin-d’Hères</option>
              <option value="Seynod">Seynod</option>
            </select>
            <button id="refreshButton" class="btn secondary">Rafraîchir</button>
          </div>
          <!-- Conteneur pour la liste des demandes -->
          <div id="adminResults" class="results"></div>
          <!-- Formulaire d'édition d'un dossier -->
          <div id="editSection" class="login-section hidden" style="margin-top:2rem;">
            <h2>Modifier le dossier</h2>
            <form id="editForm">
              <input type="hidden" id="editId" />
              <div class="form-group">
                <label for="editStatut">Statut</label>
                <select id="editStatut" name="statut">
                  <option value="enregistré">Enregistré</option>
                  <option value="en attente">En attente</option>
                  <option value="pris en charge">Pris en charge</option>
                  <option value="accepté">Accepté</option>
                  <option value="refusé">Refusé</option>
                </select>
              </div>
              <div class="form-group">
                <label for="editReponse">Réponse au client</label>
                <textarea id="editReponse" name="reponse" rows="3" placeholder="Votre message au client..."></textarea>
              </div>
              <div class="form-group">
                <label for="editNumeroAvoir">Numéro d'avoir (optionnel)</label>
                <input type="text" id="editNumeroAvoir" name="numero_avoir" placeholder="Numéro d'avoir" />
              </div>
              <div class="form-group">
                <label for="editFiles">Ajouter des fichiers (PDF, photos...)</label>
                <input type="file" id="editFiles" name="reponseFiles" multiple />
              </div>
              <div class="form-actions">
                <button type="button" id="cancelEdit" class="btn secondary">Annuler</button>
                <button type="submit" class="btn primary">Enregistrer</button>
              </div>
            </form>
            <p id="editMessage" class="message"></p>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="container footer-content">
        <p>&copy; <span id="year"></span> Durand Services Garantie</p>
      </div>
    </footer>

    <script>
      document.getElementById("year").textContent = new Date().getFullYear();

      // Variables globales pour conserver l'état de l'admin (superadmin, magasin) et la liste des dossiers chargés
      let adminInfo = { isSuper: false, isAdmin: false, magasin: null };
      let dossiers = [];

      const loginButton = document.getElementById("loginButton");
      const adminPanel = document.getElementById("adminPanel");
      const loginSection = document.getElementById("loginSection");
      const loginError = document.getElementById("loginError");

      // Gestion du login via l'API
      loginButton.addEventListener("click", async () => {
        const pwd = document.getElementById("adminPassword").value;
        loginError.textContent = "";
        if (!pwd) {
          loginError.textContent = "Veuillez saisir le mot de passe.";
          return;
        }
        try {
          const res = await fetch("/api/admin/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: pwd }),
          });
          const data = await res.json();
          if (data.success) {
            adminInfo = { isSuper: data.isSuper || false, isAdmin: data.isAdmin || false, magasin: data.magasin || null };
            loginSection.classList.add("hidden");
            adminPanel.classList.remove("hidden");
            loadDemands();
          } else {
            loginError.textContent = data.message || "Mot de passe incorrect.";
          }
        } catch (e) {
          loginError.textContent = "Erreur lors de la connexion.";
        }
      });

      document.getElementById("refreshButton").addEventListener("click", () => {
        loadDemands();
      });
      document.getElementById("filterStatut").addEventListener("change", loadDemands);
      document.getElementById("filterMagasinAdmin").addEventListener("change", loadDemands);

      // Charger toutes les demandes et construire le tableau
      async function loadDemands() {
        try {
          const res = await fetch("/api/admin/dossiers");
          const data = await res.json();
          dossiers = Array.isArray(data) ? data : [];
          // Filtrage côté client selon les sélections
          const statutSel = document.getElementById("filterStatut").value;
          const magasinSel = document.getElementById("filterMagasinAdmin").value;
          let filtered = dossiers;
          if (statutSel) filtered = filtered.filter((d) => d.statut === statutSel);
          if (magasinSel) filtered = filtered.filter((d) => d.magasin === magasinSel);
          // Si l'admin est restreint à un magasin, filtrer également
          if (!adminInfo.isSuper && !adminInfo.isAdmin && adminInfo.magasin) {
            filtered = filtered.filter((d) => d.magasin === adminInfo.magasin);
          }
          const container = document.getElementById("adminResults");
          if (!filtered.length) {
            container.innerHTML = `<p>Aucun dossier trouvé.</p>`;
            return;
          }
          let html = `<table class="data-table admin-table"><thead><tr><th>Date</th><th>Nom</th><th>E‑mail</th><th>Magasin</th><th>Produit</th><th>Statut</th><th>Actions</th></tr></thead><tbody>`;
          filtered.forEach((d) => {
            const date = new Date(d.date).toLocaleDateString();
            html += `<tr>
              <td>${date}</td>
              <td>${d.nom || ""}</td>
              <td>${d.email || ""}</td>
              <td>${d.magasin || ""}</td>
              <td>${d.produit_concerne || ""}</td>
              <td class="status" data-status="${d.statut}">${d.statut}</td>
              <td>
                <select class="statusSelect" data-id="${d.id}">
                  <option value="enregistré" ${d.statut === "enregistré" ? "selected" : ""}>Enregistré</option>
                  <option value="en attente" ${d.statut === "en attente" ? "selected" : ""}>En attente</option>
                  <option value="pris en charge" ${d.statut === "pris en charge" ? "selected" : ""}>Pris en charge</option>
                  <option value="accepté" ${d.statut === "accepté" ? "selected" : ""}>Accepté</option>
                  <option value="refusé" ${d.statut === "refusé" ? "selected" : ""}>Refusé</option>
                </select>
                <button class="btn secondary editButton" data-id="${d.id}">Éditer</button>
              </td>
            </tr>`;
          });
          html += `</tbody></table>`;
          container.innerHTML = html;
          // Gestion des changements de statut rapides
          container.querySelectorAll(".statusSelect").forEach((sel) => {
            sel.addEventListener("change", async function () {
              const id = this.getAttribute("data-id");
              const newStatus = this.value;
              const formData = new FormData();
              formData.append("statut", newStatus);
              try {
                await fetch(`/api/admin/dossier/${id}`, {
                  method: "POST",
                  body: formData,
                });
                loadDemands();
              } catch (err) {
                alert("Erreur lors de la mise à jour du statut.");
              }
            });
          });
          // Gestion du bouton Éditer
          container.querySelectorAll(".editButton").forEach((btn) => {
            btn.addEventListener("click", () => {
              const id = btn.getAttribute("data-id");
              openEditForm(id);
            });
          });
        } catch (err) {
          document.getElementById("adminResults").innerHTML = `<p class="error">Erreur de chargement des dossiers.</p>`;
        }
      }

      // Afficher le formulaire d'édition pour un dossier donné
      function openEditForm(id) {
        const dossier = dossiers.find((d) => d.id === id);
        if (!dossier) return;
        document.getElementById("editId").value = dossier.id;
        document.getElementById("editStatut").value = dossier.statut;
        document.getElementById("editReponse").value = dossier.reponse || "";
        document.getElementById("editNumeroAvoir").value = dossier.numero_avoir || "";
        document.getElementById("editFiles").value = "";
        document.getElementById("editMessage").textContent = "";
        document.getElementById("editSection").classList.remove("hidden");
        // Scroll vers le formulaire
        document.getElementById("editSection").scrollIntoView({ behavior: "smooth" });
      }

      // Annuler l'édition
      document.getElementById("cancelEdit").addEventListener("click", () => {
        document.getElementById("editSection").classList.add("hidden");
      });

      // Soumettre la mise à jour complète du dossier
      document.getElementById("editForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const id = document.getElementById("editId").value;
        const statut = document.getElementById("editStatut").value;
        const reponse = document.getElementById("editReponse").value;
        const numero = document.getElementById("editNumeroAvoir").value;
        const filesInput = document.getElementById("editFiles");
        const formData = new FormData();
        formData.append("statut", statut);
        if (reponse) formData.append("reponse", reponse);
        if (numero) formData.append("numero_avoir", numero);
        // Ajouter les fichiers sélectionnés en tant que reponseFiles
        for (const f of filesInput.files) {
          formData.append("reponseFiles", f);
        }
        const msg = document.getElementById("editMessage");
        try {
          const resp = await fetch(`/api/admin/dossier/${id}`, {
            method: "POST",
            body: formData,
          });
          const result = await resp.json();
          if (result.success || resp.ok) {
            msg.className = "message success";
            msg.textContent = "Le dossier a été mis à jour.";
            document.getElementById("editSection").classList.add("hidden");
            loadDemands();
          } else {
            msg.className = "message error";
            msg.textContent = result.message || "Erreur lors de la mise à jour.";
          }
        } catch (err) {
          msg.className = "message error";
          msg.textContent = "Erreur lors de la mise à jour.";
        }
      });
    </script>
  </body>
</html>