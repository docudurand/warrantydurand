<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Suivi de mes dossiers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f9fafb; margin:0; }
    .container { max-width:1300px; margin:34px auto 0 auto; background:#fff; border-radius:24px; box-shadow:0 3px 20px #0001; padding:44px 28px 38px 28px; box-sizing: border-box;}
    h2 { color:#006e90; font-size:2.10em; font-weight:bold; text-align:center; margin-bottom:38px; letter-spacing: 0.01em;}
    .ligne1 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 18px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .ligne2 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 24px;
      flex-wrap: wrap;
    }
    .gauche {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .droite {
      display: flex;
      align-items: center;
      gap: 18px;
      flex-wrap: wrap;
    }
    label {
      font-size: 1.13em;
      color: #146083;
      font-weight: 500;
    }
    input[type="text"], select {
      padding: 8px 13px;
      border-radius: 7px;
      border: 1px solid #b4c8d8;
      font-size: 1.09em;
      background: #f9fafb;
    }
    input[type="text"].mail { min-width: 250px; }
    input[type="text"].recherche { min-width: 180px; }
    .suivi-btn {
      background:#006e90; color:#fff; border-radius:8px; border:none;
      padding:10px 32px; font-size:1.13em; font-weight:700; cursor:pointer;
      transition: background 0.16s;
      margin-left: 8px;
    }
    .suivi-btn:hover { background: #1780b0; }
    @media (max-width: 1050px) {
      .ligne2 { flex-direction: column; align-items: stretch; gap: 13px;}
      .gauche, .droite { justify-content: flex-start; }
    }
    table { width:100%; border-collapse:collapse; margin-bottom:16px; table-layout:fixed;}
    th, td { border:1px solid #e6edf1; padding:12px 7px; text-align:center; font-size:1.09em; word-break:break-word;}
    th { background:#006e90; color:#fff; font-size:1.12em; font-weight:600;}
    tr:nth-child(even) td { background:#f4fafd;}
    .msg-erreur { color:#bb1810; text-align:center; margin: 30px 0 20px; font-size:1.12em;}
    .pj-img { max-width:70px; max-height:54px; border-radius:3px; box-shadow:0 1px 3px #0002; }
    .hidden { display: none !important; }
    .voir-btn { background:#006e90; color:#fff; border:none; padding:7px 20px; border-radius:6px; cursor:pointer; font-size:1em; box-shadow:0 1px 4px #0002; transition:background 0.15s;}
    .voir-btn:hover { background:#1780b0;}
    .statut-chip { display:inline-flex; align-items:center; gap:6px; font-weight:600; font-size:1em;}
    .statut-dot { display:inline-block; width:15px; height:15px; border-radius:50%; margin-right:2px; }
    .statut-dot.enregistre { background:#f8a900; border: 2px solid #f7ce65; }
    .statut-dot.accepte { background:#16c11c; border: 2px solid #a6ebba; }
    .statut-dot.refuse { background:#bb1810; border: 2px solid #f49e9e; }
    .statut-dot.info { background:#1978d2; border: 2px solid #93c7fa; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Suivi de mes dossiers</h2>
    <form id="form-suivi" onsubmit="event.preventDefault(); afficherDossiers();">
      <div class="ligne1">
        <label for="input-mail">Email :</label>
        <input type="text" id="input-mail" class="mail" placeholder="Votre adresse mail" autocomplete="email"/>
        <button class="suivi-btn" type="submit">Afficher mes dossiers</button>
      </div>
      <div class="ligne2 hidden" id="ligne2-filtres">
        <div class="gauche">
          <label for="input-recherche">Nom client :</label>
          <input type="text" id="input-recherche" class="recherche" placeholder="Recherche nom client"/>
        </div>
        <div class="droite">
          <label for="mois-filter">Mois :</label>
          <select id="mois-filter"><option value="">Tous</option></select>
          <label for="annee-filter">Année :</label>
          <select id="annee-filter"><option value="">Toutes</option></select>
          <label for="statut-filter">Statut :</label>
          <select id="statut-filter">
            <option value="">Tous</option>
            <option value="enregistré">Enregistré</option>
            <option value="accepté">Accepté</option>
            <option value="refusé">Refusé</option>
            <option value="en attente d'info">En attente d'info</option>
          </select>
        </div>
      </div>
    </form>
    <div id="dossiers-list"></div>
  </div>
  <script>
    let dossiersData = [];
    let filtres = { mois:"", annee:"", statut:"" };
    const inputMail = document.getElementById("input-mail");
    if (localStorage.getItem("suiviEmail")) {
      inputMail.value = localStorage.getItem("suiviEmail");
    }
    inputMail.addEventListener("input", function() {
      localStorage.setItem("suiviEmail", this.value.trim());
    });

    document.getElementById("mois-filter").onchange = function(){ filtres.mois = this.value; afficherListe(); }
    document.getElementById("annee-filter").onchange = function(){ filtres.annee = this.value; afficherListe(); }
    document.getElementById("statut-filter").onchange = function(){ filtres.statut = this.value; afficherListe(); }
    document.getElementById("input-recherche").oninput = function(){ afficherListe(); }

    function afficherDossiers() {
      let email = inputMail.value.trim();
      const ligne2 = document.getElementById("ligne2-filtres");
      ligne2.classList.add("hidden");
      if(!email || !email.includes("@")){
        document.getElementById("dossiers-list").innerHTML = '<div class="msg-erreur">Veuillez entrer une adresse mail valide.</div>';
        return;
      }
      document.getElementById("dossiers-list").innerHTML = "Chargement...";
      fetch('https://durandservicesgarantie.onrender.com/api/mes-dossiers?email='+encodeURIComponent(email))
        .then(r=>r.json())
        .then(data=>{
          dossiersData = data;
          genererFiltres();
          afficherListe();
        });
    }

    function genererFiltres() {
      let moisSet = new Set(), anneeSet = new Set();
      dossiersData.forEach(d => {
        let date = new Date(d.date);
        if (!isNaN(date)) {
          let mois = ("0" + (date.getMonth() + 1)).slice(-2);
          let annee = date.getFullYear().toString();
          moisSet.add(mois);
          anneeSet.add(annee);
        }
      });
      const moisFr = ["01","02","03","04","05","06","07","08","09","10","11","12"];
      const moisLib = ["Jan","Fév","Mar","Avr","Mai","Juin","Juil","Août","Sep","Oct","Nov","Déc"];
      let moisSel = document.getElementById("mois-filter");
      moisSel.innerHTML = `<option value="">Tous</option>`;
      moisFr.forEach((m,i)=>{ if(moisSet.has(m)) moisSel.innerHTML += `<option value="${m}">${moisLib[i]}</option>`; });
      let anneeSel = document.getElementById("annee-filter");
      anneeSel.innerHTML = `<option value="">Toutes</option>`;
      Array.from(anneeSet).sort().forEach(a=>{ anneeSel.innerHTML += `<option value="${a}">${a}</option>`; });
      moisSel.value = filtres.mois;
      anneeSel.value = filtres.annee;
    }

    function statutChip(statut) {
      let s = (statut||"").toLowerCase();
      if (s==="enregistré") return `<span class="statut-chip"><span class="statut-dot enregistre"></span>Enregistré</span>`;
      if (s==="accepté") return `<span class="statut-chip"><span class="statut-dot accepte"></span>Accepté</span>`;
      if (s==="refusé") return `<span class="statut-chip"><span class="statut-dot refuse"></span>Refusé</span>`;
      if (s==="en attente d'info") return `<span class="statut-chip"><span class="statut-dot info"></span>En attente d'info</span>`;
      return statut||"";
    }

    function afficherListe() {
      const ligne2 = document.getElementById("ligne2-filtres");
      let recherche = document.getElementById("input-recherche").value.trim().toLowerCase();
      let dossiers = dossiersData;
      if (recherche) {
        dossiers = dossiers.filter(d => (d.nom||"").toLowerCase().includes(recherche));
      }
      if(filtres.mois) {
        dossiers = dossiers.filter(d=>{
          let date = new Date(d.date);
          return !isNaN(date) && ("0"+(date.getMonth()+1)).slice(-2) === filtres.mois;
        });
      }
      if(filtres.annee) {
        dossiers = dossiers.filter(d=>{
          let date = new Date(d.date);
          return !isNaN(date) && date.getFullYear().toString() === filtres.annee;
        });
      }
      if(filtres.statut) {
        dossiers = dossiers.filter(d=>d.statut===filtres.statut);
      }

      let serverUrl = "https://durandservicesgarantie.onrender.com";

      let html = '';
      if(!dossiers.length) {
        html = '<div class="msg-erreur">Aucun dossier trouvé avec ces filtres.</div>';
        ligne2.classList.add("hidden");
      } else {
        ligne2.classList.remove("hidden");
        html = `<table>
          <tr>
            <th>Date</th>
            <th>Produit</th>
            <th>Immatriculation</th>
            <th>Statut</th>
            <th>Réponse</th>
            <th class="files-col">Pièces jointes</th>
            <th class="files-col">Fichiers réponse</th>
            <th class="action">Voir</th>
          </tr>`;
        dossiers.forEach(d=>{
          html += `<tr>
            <td>${new Date(d.date).toLocaleDateString("fr-FR")}</td>
            <td>${d.produit_concerne||''}</td>
            <td>${d.immatriculation||''}</td>
            <td>${statutChip(d.statut)}</td>
            <td>${d.reponse ? d.reponse.replace(/\n/g,"<br>") : ''}</td>
            <td class="files-col">
              ${(d.files||[]).length ? d.files.map(f=>{
                let ext = f.original.split('.').pop().toLowerCase();
                let link = serverUrl + "/download/" + encodeURIComponent(f.url);
                if(["jpg","jpeg","png","gif","webp","bmp"].includes(ext)){
                  return `<a href="${link}" download target="_blank"><img src="${serverUrl}/uploads/${encodeURIComponent(f.url)}" class="pj-img"></a>`;
                } else {
                  return `<a href="${link}" download title="${f.original}">${f.original}</a>`;
                }
              }).join("<br>") : ""}
            </td>
            <td class="files-col">
              ${(d.reponseFiles||[]).length ? d.reponseFiles.map(f=>{
                let ext = f.original.split('.').pop().toLowerCase();
                let link = serverUrl + "/download/" + encodeURIComponent(f.url);
                if(["jpg","jpeg","png","gif","webp","bmp"].includes(ext)){
                  return `<a href="${link}" download target="_blank"><img src="${serverUrl}/uploads/${encodeURIComponent(f.url)}" class="pj-img"></a>`;
                } else {
                  return `<a href="${link}" download title="${f.original}">${f.original}</a>`;
                }
              }).join("<br>") : ""}
            </td>
            <td class="action"><button class="voir-btn" onclick="voirDossier('${d.id}')">Voir</button></td>
          </tr>`;
        });
        html += `</table>`;
      }
      document.getElementById("dossiers-list").innerHTML = html;
    }

    function voirDossier(id) {
      let d = dossiersData.find(x=>x.id===id);
      if (!d) return alert("Dossier introuvable !");
      let logoUrl = "https://raw.githubusercontent.com/docudurand/warrantydurand/main/DSG.png";
      let serverUrl = "https://durandservicesgarantie.onrender.com";
      let dateCreation = d.date ? new Date(d.date).toLocaleDateString("fr-FR") : "";
      let clientNom = (d.nom||"Client").replace(/[^a-zA-Z0-9]/g, "_").toUpperCase();
      let dateStr = "";
      if (d.date) {
        let dt = new Date(d.date);
        if (!isNaN(dt)) {
          dateStr = dt.toISOString().slice(0,10); // "YYYY-MM-DD"
        }
      }
      let nomFichier = `${clientNom}${dateStr ? "_" + dateStr : ""}`;
      let detailHtml = `
      <html><head>
      <meta charset="UTF-8">
      <title>${nomFichier}</title>
      <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background:#f9fafb; margin:0; }
        .fiche-header { display:flex; align-items:center; gap:18px; margin-bottom:18px; }
        .fiche-header img { height:62px; border-radius:11px; box-shadow:0 2px 12px #0001; background:#fff;}
        .fiche-header .magasin-title { font-size:1.22em; font-weight:600; color:#17537a; }
        .fiche-date { margin-left:auto; font-size:1.08em; color:#444; font-weight:bold;}
        .fiche-table { max-width:700px; margin:30px auto; background:#fff; border-radius:10px; border:1px solid #e5e7eb; padding:18px 24px 14px 24px; }
        .fiche-table table { width:100%; border-collapse:collapse; }
        .fiche-table th, .fiche-table td { text-align:left; padding:8px 10px; border:none; }
        .fiche-table th { color:#194e72; font-size:1.06em; text-align:left; width:220px; vertical-align:top;}
        .fiche-table tr { border-bottom:1px solid #f0f0f0;}
        .fiche-title { font-weight:bold; color:#006e90; padding-top:24px; font-size:1.08em;}
        .pj-img { max-width:180px; max-height:120px; display:block; margin-bottom:6px; border-radius:5px; box-shadow:0 2px 6px #0002; }
        .fiche-actions { text-align:right; margin-bottom:14px;}
        .print-btn { background:#006e90; color:#fff; border:none; padding:9px 22px; border-radius:7px; font-size:1.07em; font-weight:600; cursor:pointer; margin-left:7px;}
        .print-btn:hover { background:#1780b0; }
        @media print {
          .print-btn { display:none !important; }
          body { background: #fff; }
          .fiche-table { box-shadow: none; border:1px solid #888;}
          .fiche-header { padding-top:10px; }
          .hide-print { display:none !important; }
          .fiche-date { display:block !important; position:absolute; top:24px; right:40px; font-size:1.09em;}
        }
        .statut-chip { display:inline-flex; align-items:center; gap:
        .statut-chip { display:inline-flex; align-items:center; gap:6px; font-weight:600; font-size:1em;}
        .statut-dot { display:inline-block; width:15px; height:15px; border-radius:50%; margin-right:2px; }
        .statut-dot.enregistre { background:#f8a900; border: 2px solid #f7ce65; }
        .statut-dot.accepte { background:#16c11c; border: 2px solid #a6ebba; }
        .statut-dot.refuse { background:#bb1810; border: 2px solid #f49e9e; }
        .statut-dot.info { background:#1978d2; border: 2px solid #93c7fa; }
      </style>
      </head><body>
      <div class="fiche-header">
        <img src="${logoUrl}" alt="Logo DSG">
        <span class="magasin-title">${d.magasin||""}</span>
        <span class="fiche-date" style="margin-left:auto;">Créé le : ${dateCreation}</span>
      </div>
      <div class="fiche-table">
        <div class="fiche-actions">
          <button class="print-btn" onclick="renameAndPrint('${nomFichier}')">🖨️ Imprimer</button>
        </div>
        <table>
          <tr><th>Nom du client</th><td>${d.nom||""}</td></tr>
          <tr><th>Email</th><td>${d.email||""}</td></tr>
          <tr><th>Magasin</th><td>${d.magasin||""}</td></tr>
          <tr><td colspan="2" class="fiche-title">Produit</td></tr>
          <tr><th>Marque du produit</th><td>${d.marque_produit||""}</td></tr>
          <tr><th>Produit concerné</th><td>${d.produit_concerne||""}</td></tr>
          <tr><th>Référence de la pièce</th><td>${d.reference_piece||""}</td></tr>
          <tr><th>Quantité posée</th><td>${d.quantite_posee||""}</td></tr>
          <tr><td colspan="2" class="fiche-title">Véhicule</td></tr>
          <tr><th>Immatriculation</th><td>${d.immatriculation||""}</td></tr>
          <tr><th>Marque</th><td>${d.marque_vehicule||""}</td></tr>
          <tr><th>Modèle</th><td>${d.modele_vehicule||""}</td></tr>
          <tr><th>Numéro de série</th><td>${d.num_serie||""}</td></tr>
          <tr><th>1ère immatriculation</th><td>${d.premiere_immat||""}</td></tr>
          <tr><td colspan="2" class="fiche-title">Problème</td></tr>
          <tr><th>Date de pose</th><td>${d.date_pose||""}</td></tr>
          <tr><th>Date du constat</th><td>${d.date_constat||""}</td></tr>
          <tr><th>Kilométrage à la pose</th><td>${d.km_pose||""}</td></tr>
          <tr><th>Kilométrage au constat</th><td>${d.km_constat||""}</td></tr>
          <tr><th>N° BL 1ère Vente</th><td>${d.bl_pose||""}</td></tr>
          <tr><th>N° BL 2ème Vente</th><td>${d.bl_constat||""}</td></tr>
          <tr><th>Problème rencontré</th><td>${d.probleme_rencontre||""}</td></tr>
          <tr class="hide-print"><th>Statut</th><td>${statutChip(d.statut)}</td></tr>
          <tr class="hide-print"><th>Pièces jointes</th><td>
            ${
              (d.files||[]).length === 0
                ? 'Aucune'
                : d.files.map(f=>{
                    let ext = f.original.split('.').pop().toLowerCase();
                    let link = serverUrl + "/download/" + encodeURIComponent(f.url);
                    if(["jpg","jpeg","png","gif","webp","bmp"].includes(ext)){
                      return `<a href="${link}" target="_blank"><img src="${serverUrl}/uploads/${encodeURIComponent(f.url)}" class="pj-img"></a>`;
                    } else {
                      return `<a href="${link}" target="_blank">${f.original}</a>`;
                    }
                  }).join("<br>")
            }
          </td></tr>
          <tr class="hide-print"><th>Réponse</th><td>
            ${(d.reponse||"")}
            ${(d.reponseFiles||[]).length
                ? "<br>"+d.reponseFiles.map(f=>{
                  let ext = f.original.split('.').pop().toLowerCase();
                  let link = serverUrl + "/download/" + encodeURIComponent(f.url);
                  if(["jpg","jpeg","png","gif","webp","bmp"].includes(ext)){
                    return `<a href="${link}" target="_blank"><img src="${serverUrl}/uploads/${encodeURIComponent(f.url)}" class="pj-img"></a>`;
                  } else {
                    return `<a href="${link}" target="_blank">${f.original}</a>`;
                  }
                }).join("<br>")
                : ""}
          </td></tr>
        </table>
      </div>
      <script>
        function renameAndPrint(filename) {
          var oldTitle = document.title;
          document.title = filename;
          window.print();
          setTimeout(function() {
            document.title = oldTitle;
          }, 1500);
        }
        window.onbeforeprint = function() {
          document.title = "${nomFichier}";
        };
        window.onafterprint = function() {
          setTimeout(function(){
            document.title = "${nomFichier}";
          }, 500);
        };
      <\/script>
      </body></html>
      `;
      let w = window.open("", "_blank", "width=820,height=900");
      w.document.write(detailHtml);
      w.document.close();
    }
  </script>
</body>
</html>
